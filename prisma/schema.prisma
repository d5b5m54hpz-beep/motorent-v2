generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ─── Auth ────────────────────────────────────────────────────────────────────

model User {
  id                      String             @id @default(cuid())
  email                   String             @unique
  name                    String
  image                   String?
  provider                String             // "credentials" | "google" | "apple" | "facebook"
  password                String?
  phone                   String?
  phoneVerifiedAt         DateTime?
  role                    Role               @default(CLIENTE)
  createdAt               DateTime           @default(now())
  updatedAt               DateTime           @updatedAt
  cliente                 Cliente?
  facturasAprobadas       FacturaCompra[]    @relation("FacturaAprobador")
  facturasCreadas         FacturaCompra[]    @relation("FacturaCreador")
  auditLogs               AuditLog[]
  periodosCerrados        PeriodoContable[]
  diagnosticosEjecutados  DiagnosticoRun[]
  historialEstadosMotos   HistorialEstadoMoto[]
  notasCreditoCreadas     NotaCredito[]
}

enum Role {
  ADMIN
  OPERADOR
  CLIENTE
  CONTADOR
  RRHH_MANAGER
  COMERCIAL
  VIEWER
}

// ─── Negocio ─────────────────────────────────────────────────────────────────

model Cliente {
  id                  String     @id @default(cuid())
  userId              String     @unique
  nombre              String?
  email               String     @unique
  telefono            String?
  dni                 String?
  dniVerificado       Boolean    @default(false)
  licencia            String?
  licenciaVencimiento DateTime?
  licenciaVerificada  Boolean    @default(false)
  direccion           String?
  ciudad              String?
  provincia           String?
  codigoPostal        String?
  fechaNacimiento     DateTime?
  notas               String?
  estado              String     @default("pendiente") // pendiente | aprobado | rechazado
  preRegistro         Json?
  aprobadoPor         String?
  aprobadoAt          DateTime?

  // ─── Puntaje de rider (nuevo módulo mantenimientos) ──────────────────────
  puntajePromedio        Float     @default(100) // Promedio histórico
  totalServices          Int       @default(0)
  servicesAsistidos      Int       @default(0)
  servicesNoAsistidos    Int       @default(0)

  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @default(now()) @updatedAt
  user                User       @relation(fields: [userId], references: [id])
  contratos           Contrato[]
  notasCredito        NotaCredito[]
  citasMantenimiento  CitaMantenimiento[]
  ordenesTrabajoRider OrdenTrabajo[] @relation("OrdenTrabajoRider")
  puntajes            PuntajeRider[]

  // ─── Relaciones nuevas pricing motor ──────────────────────────
  gruposCliente       MiembroGrupoCliente[]
}

model Moto {
  id             String          @id @default(cuid())
  marca          String
  modelo         String
  patente        String          @unique
  anio           Int
  color          String?
  kilometraje    Int             @default(0)
  precioMensual  Float           @default(0)
  cilindrada     Int?
  tipo           String? // naked | touring | sport | scooter | custom
  descripcion    String?
  imagen         String?
  estado         String          @default("disponible") // disponible | alquilada | mantenimiento | baja
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  contratos      Contrato[]
  gastos         Gasto[]
  facturasCompra FacturaCompra[]

  // ─── Identificación vehicular ───────────────────────────────────────────
  vin               String?   // VIN 17 caracteres
  numeroMotor       String?
  numeroCuadro      String?
  anioFabricacion   Int?
  paisOrigen        String?   // CHINA, INDIA, BRASIL, JAPON, etc

  // ─── Datos registrales DNRPA ────────────────────────────────────────────
  dominio           String?   @unique // Patente formato AA000AA
  fechaPatentamiento DateTime?
  registroSeccional String?
  titularRegistral  String?
  cedulaVerde       String?
  cedulaAzul        String?

  // ─── Financiero / Amortización ──────────────────────────────────────────
  valorCompra       Float?    // Costo adquisición (CIF si importada)
  fechaCompra       DateTime?
  valorResidual     Float?    // Valor residual estimado
  vidaUtilAnios     Int?      @default(5) // AFIP: 5 años para vehículos
  metodoAmortizacion String?  @default("LINEAL")

  // ─── Importación ────────────────────────────────────────────────────────
  esImportada       Boolean   @default(true)
  numeroDespachImport String?
  fechaImportacion  DateTime?
  valorFOB          Float?
  valorCIF          Float?
  derechosImportacion Float?

  // ─── Estado legal ───────────────────────────────────────────────────────
  estadoLegal       String?   @default("REGULAR") // REGULAR, DENUNCIA_ROBO, SINIESTRO_TOTAL, BAJA_DEFINITIVA, EN_PROCESO_PATENTAMIENTO, PRENDA

  // === PATENTAMIENTO ===
  estadoPatentamiento    String?   @default("SIN_PATENTAR") // SIN_PATENTAR | EN_TRAMITE | PATENTADA
  fechaInicioTramitePatente DateTime?
  notasPatentamiento     String?

  // === SEGURO ===
  estadoSeguro           String?   @default("SIN_SEGURO") // SIN_SEGURO | EN_TRAMITE | ASEGURADA
  aseguradora            String?
  numeroPoliza           String?
  tipoCobertura          String?   // RESPONSABILIDAD_CIVIL, TERCEROS_COMPLETO, TODO_RIESGO (legacy)
  fechaInicioSeguro      DateTime?
  fechaVencimientoSeguro DateTime?
  vencimientoPoliza      DateTime? // LEGACY - usar fechaVencimientoSeguro
  notasSeguro            String?

  // ─── Mantenimientos (nuevo módulo) ──────────────────────────────────────
  fechaInicioOperaciones DateTime? // Fecha en que la moto empezó a operar (define ciclo mensual)
  kmActual               Int       @default(0) // Última lectura de km (actualizado por IoT)
  kmUltimoService        Int       @default(0) // Km en el último service completado
  fechaUltimoService     DateTime? // Fecha del último service completado
  proximoServiceFecha    DateTime? // Fecha calculada del próximo service
  proximoServiceTipo     TipoService? // Tipo de service que le toca según km

  // ─── Relaciones nuevas ──────────────────────────────────────────────────
  amortizaciones     Amortizacion[]
  documentos         DocumentoMoto[]
  historialEstados   HistorialEstadoMoto[]
  bajaMoto           BajaMoto?
  citasMantenimiento CitaMantenimiento[]
  ordenesTrabajoMoto OrdenTrabajo[]
  lecturasKm         LecturaKm[]
}

model Contrato {
  id                String   @id @default(cuid())
  clienteId         String
  motoId            String
  fechaInicio       DateTime
  fechaFin          DateTime
  frecuenciaPago    String   @default("mensual") // semanal | quincenal | mensual
  montoPeriodo      Float // Monto por período según frecuencia
  montoTotal        Float // Monto total del contrato
  deposito          Float    @default(0)
  descuentoAplicado Float    @default(0)
  notas             String?
  renovacionAuto    Boolean  @default(false)
  estado            String   @default("pendiente") // pendiente | activo | finalizado | cancelado | finalizado_compra

  // ─── Opción a Compra ────────────────────────────────────────────────────
  esOpcionCompra    Boolean  @default(false)
  mesesParaCompra   Int?     @default(24)
  valorCompraFinal  Float?   // Precio al ejercer opción
  opcionEjercida    Boolean  @default(false)
  fechaEjercicio    DateTime?

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  cliente           Cliente  @relation(fields: [clienteId], references: [id])
  moto              Moto     @relation(fields: [motoId], references: [id])
  pagos             Pago[]
  alertas           Alerta[]
}

model Pago {
  id            String    @id @default(cuid())
  contratoId    String
  monto         Float
  metodo        String    @default("pendiente") // transferencia | tarjeta | mercadopago | efectivo | pendiente
  estado        String    @default("pendiente") // pendiente | aprobado | rechazado | reembolsado | cancelado
  referencia    String?
  mpPaymentId   String? // ID de transacción de MercadoPago
  comprobante   String? // URL o texto del comprobante
  notas         String? // Notas adicionales del pago
  pagadoAt      DateTime?
  vencimientoAt DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  contrato      Contrato  @relation(fields: [contratoId], references: [id])
  factura       Factura?
  alertas       Alerta[]
}

model Factura {
  id             String    @id @default(cuid())
  numero         String // Autoincremental 00000001, 00000002, etc.
  tipo           String // A, B, C
  puntoVenta     Int       @default(1)
  montoNeto      Float // Subtotal sin IVA (si tipo A)
  montoIva       Float // IVA 21% (si tipo A)
  montoTotal     Float // Total final
  cae            String? // Código de Autorización Electrónico de AFIP
  caeVencimiento String? // Fecha de vencimiento del CAE
  razonSocial    String? // Razón social del cliente (opcional)
  cuit           String? // CUIT del cliente (opcional)
  emitida        Boolean   @default(false) // false = pendiente AFIP, true = emitida con CAE
  emailEnviado   Boolean   @default(false) // true si se envió por email
  emailEnviadoAt DateTime? // Fecha/hora del último envío por email
  pagoId         String    @unique
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  pago           Pago      @relation(fields: [pagoId], references: [id])
}

model Alerta {
  id              String    @id @default(cuid())
  tipo            String
  mensaje         String
  metadata        Json?
  contratoId      String?
  pagoId          String?
  leida           Boolean   @default(false)
  dniVerificacion Json?
  createdAt       DateTime  @default(now())
  contrato        Contrato? @relation(fields: [contratoId], references: [id])
  pago            Pago?     @relation(fields: [pagoId], references: [id])
}

// ─── Proveedores y Repuestos (mantienen compatibilidad) ────────────────────

model Proveedor {
  id             String          @id @default(cuid())
  visibleId      String          @unique @default(cuid())
  nombre         String
  cuit           String?
  condicionIva   CondicionIva?
  contacto       String?
  telefono       String?
  email          String?
  direccion      String?
  rubro          String?
  notas          String?
  activo         Boolean         @default(true)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  repuestos      Repuesto[]
  gastos         Gasto[]
  facturasCompra FacturaCompra[]
  ordenesCompra  OrdenCompra[]
  embarques      EmbarqueImportacion[]
}

model Repuesto {
  id           String          @id @default(cuid())
  visibleId    String          @unique @default(cuid())
  nombre       String
  codigo       String?
  categoria    String?
  precioCompra Float           @default(0)
  precioVenta  Float           @default(0)
  stock        Int             @default(0)
  stockMinimo  Int             @default(2)
  proveedorId  String?
  proveedor    Proveedor?      @relation(fields: [proveedorId], references: [id])
  unidad       String?
  vidaUtilKm   Int?

  // ─── Campos nuevos V2 ─────────────────────────────────────────
  descripcion      String?   // Descripción detallada / notas
  marca            String?   // Marca del repuesto
  modelo           String?   // Modelo compatible (ej: "Honda Wave 110")
  imagenUrl        String?   // URL de foto del repuesto en R2
  imagenKey        String?   // Key en R2 para poder eliminar
  ubicacion        String?   // Ubicación en depósito: "E2-F3-P1" (Estante-Fila-Posición)
  codigoBarras     String?   // Código de barras del fabricante
  unidadCompra     String?   // "caja", "bolsa", "unidad"
  factorConversion Float?    @default(1) // Cuántas unidades hay en 1 unidad de compra (ej: caja de 12 = 12)
  peso             Float?    // Peso en gramos (para envíos/logística)
  activo           Boolean   @default(true) // Para dar de baja sin eliminar

  // ─── Campos nuevos de costeo ──────────────────────────────────
  ncmCodigo          String?   // Nomenclatura Común del Mercosur (ej: "8714.10.00")
  pesoUnitarioKg     Float?    // Peso por unidad en kg (para prorrateo de flete)
  volumenUnitarioCbm Float?    // Volumen por unidad en CBM (para prorrateo)
  esOEM              Boolean   @default(false) // Original vs genérico
  costoPromedioArs   Float     @default(0) // Costo promedio ponderado actual en ARS
  costoPromedioUsd   Float     @default(0) // Costo promedio ponderado actual en USD
  ultimoCostoUpdate  DateTime? // Última vez que se recalculó el costo promedio
  margenObjetivo     Float?    // Margen objetivo para esta pieza (override de categoría)
  margenMinimo       Float?    // Margen mínimo (override de categoría)

  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  tareasPlan   TareaPlan[]
  repuestosOT  RepuestoOrdenTrabajo[]
  repuestosTareaPlan RepuestoTareaPlan[]

  // ─── Relaciones nuevas V2 ────────────────────────────────────
  movimientos      MovimientoStock[]
  itemsOrdenCompra ItemOrdenCompra[]
  itemsRecepcion   ItemRecepcion[]

  // ─── Relaciones nuevas costeo ─────────────────────────────────
  historialCostos    HistorialCostoRepuesto[]
  asignacionesCosto  AsignacionCostoImportacion[]
  itemsEmbarque      ItemEmbarque[]

  // ─── Relaciones nuevas pricing motor ──────────────────────────
  itemsListaPrecio   ItemListaPrecio[]
  historialPrecios   HistorialPrecioRepuesto[]
}

// ─── Finanzas ───────────────────────────────────────────────────────────────

model Gasto {
  id              String         @id @default(cuid())
  visibleId       String         @unique @default(cuid())
  concepto        String
  descripcion     String?
  monto           Float
  categoria       CategoriaGasto
  subcategoria    String?
  motoId          String?
  moto            Moto?          @relation(fields: [motoId], references: [id])
  proveedorId     String?
  proveedor       Proveedor?     @relation(fields: [proveedorId], references: [id])
  metodoPago      String?
  comprobante     String?
  fecha           DateTime       @default(now())
  notas           String?
  facturaCompra   FacturaCompra?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
}

model PresupuestoMensual {
  id                 String         @id @default(cuid())
  mes                Int
  anio               Int
  categoria          CategoriaGasto
  montoPresupuestado Float
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt

  @@unique([mes, anio, categoria])
}

enum CategoriaGasto {
  MANTENIMIENTO
  COMBUSTIBLE
  SEGURO
  PATENTE
  REPUESTOS
  ALQUILER_LOCAL
  SERVICIOS
  SUELDOS
  MARKETING
  IMPUESTOS
  GRUA
  ADMINISTRATIVO
  OTRO
}

// ─── Pricing ────────────────────────────────────────────────────────────────

model PricingConfig {
  id                String   @id @unique @default("default")
  precioBaseMensual Float
  descuentoSemanal  Float
  descuentoMeses3   Float
  descuentoMeses6   Float
  descuentoMeses9   Float
  descuentoMeses12  Float
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model ConfiguracionEmpresa {
  id                   String        @id @unique @default("default")
  razonSocial          String        @default("MotoLibre S.A.S")
  cuit                 String?
  condicionIva         CondicionIva  @default(RESPONSABLE_INSCRIPTO)
  domicilioComercial   String?
  domicilioFiscal      String?
  inicioActividades    DateTime?
  telefono             String?
  email                String?
  actividadPrincipal   String?
  puntoVentaAfip       String?
  certificadoAfipPath  String?
  createdAt            DateTime      @default(now())
  updatedAt            DateTime      @updatedAt
}

enum CondicionIva {
  RESPONSABLE_INSCRIPTO
  MONOTRIBUTISTA
  EXENTO
  NO_RESPONSABLE
  CONSUMIDOR_FINAL
}

// ─── Contabilidad ───────────────────────────────────────────────────────────

model FacturaCompra {
  id        String @id @default(cuid())
  visibleId String @unique @default(cuid())

  // Proveedor
  proveedorId String?
  proveedor   Proveedor? @relation(fields: [proveedorId], references: [id])
  razonSocial String
  cuit        String?

  // Invoice
  tipo        TipoFacturaCompra
  numero      String
  puntoVenta  String?
  fecha       DateTime
  vencimiento DateTime?

  // Impuestos argentinos
  subtotal       Float
  iva21          Float @default(0)
  iva105         Float @default(0)
  iva27          Float @default(0)
  percepcionIVA  Float @default(0)
  percepcionIIBB Float @default(0)
  impInterno     Float @default(0)
  noGravado      Float @default(0)
  exento         Float @default(0)
  total          Float

  // Categorización
  categoria    CategoriaGasto
  subcategoria String?
  centroGasto  String?
  motoId       String?
  moto         Moto?          @relation(fields: [motoId], references: [id])

  // Estado y Workflow
  estado             EstadoFacturaCompra @default(BORRADOR)
  estadoAnterior     EstadoFacturaCompra?
  estadoMotivo       String?
  montoAbonado       Float               @default(0)
  aprobadoPor        String?
  aprobadoFecha      DateTime?
  aprobador          User?               @relation("FacturaAprobador", fields: [aprobadoPor], references: [id])
  creadoPor          String?
  creador            User?               @relation("FacturaCreador", fields: [creadoPor], references: [id])

  // Archivo + OCR
  archivoUrl    String?
  archivoNombre String?
  ocrRawData    Json?
  ocrConfianza  Float?
  ocrRevisado   Boolean @default(false)

  // CAE (Código Autorización Electrónico)
  cae                String?
  caeVencimiento     DateTime?
  caeVerificado      Boolean?
  caeVerificadoFecha DateTime?

  // Control de Duplicidad
  hashUnico String? @unique

  // Relaciones
  gastoId   String?          @unique
  gasto     Gasto?           @relation(fields: [gastoId], references: [id])
  asientoId String?          @unique
  asiento   AsientoContable? @relation(fields: [asientoId], references: [id])
  auditLogs AuditLog[]

  notas     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([fecha])
  @@index([proveedorId])
  @@index([estado])
  @@index([vencimiento])
  @@index([hashUnico])
  @@index([cuit, tipo, puntoVenta, numero])
}

model CuentaContable {
  id          String         @id @default(cuid())
  codigo      String         @unique
  nombre      String
  tipo        TipoCuenta
  padre       String?
  nivel       Int            @default(1)
  imputable   Boolean        @default(true)
  activa      Boolean        @default(true)
  descripcion String?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  lineas      LineaAsiento[]

  @@index([tipo])
  @@index([codigo])
}

model AsientoContable {
  id              String         @id @default(cuid())
  visibleId       String         @unique @default(cuid())
  numero          Int            @unique @default(autoincrement())
  fecha           DateTime
  tipo            TipoAsiento
  descripcion     String
  totalDebe       Float
  totalHaber      Float
  facturaCompraId String?        @unique
  facturaCompra   FacturaCompra?
  cerrado         Boolean        @default(false)
  creadoPor       String?
  notas           String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  lineas          LineaAsiento[]

  @@index([fecha])
  @@index([tipo])
}

model LineaAsiento {
  id          String          @id @default(cuid())
  asientoId   String
  asiento     AsientoContable @relation(fields: [asientoId], references: [id], onDelete: Cascade)
  orden       Int
  cuentaId    String
  cuenta      CuentaContable  @relation(fields: [cuentaId], references: [id])
  debe        Float           @default(0)
  haber       Float           @default(0)
  descripcion String?
  createdAt   DateTime        @default(now())

  @@index([asientoId])
}

enum TipoFacturaCompra {
  A
  B
  C
  TICKET
  RECIBO
}

enum EstadoFacturaCompra {
  BORRADOR
  PENDIENTE
  PENDIENTE_REVISION
  APROBADA
  RECHAZADA
  PAGADA
  PAGADA_PARCIAL
  VENCIDA
  ANULADA
}

enum TipoCuenta {
  ACTIVO
  PASIVO
  PATRIMONIO
  INGRESO
  EGRESO
}

enum TipoAsiento {
  APERTURA
  COMPRA
  VENTA
  PAGO
  COBRO
  AJUSTE
  CIERRE
}

// ─── RRHH ────────────────────────────────────────────────────────────────────

model Empleado {
  id        String @id @default(cuid())
  visibleId String @unique @default(cuid())

  // Datos personales
  nombre             String
  apellido           String
  dni                String    @unique
  cuil               String?   @unique
  fechaNacimiento    DateTime?
  sexo               String? // M, F, X
  estadoCivil        String? // SOLTERO, CASADO, DIVORCIADO, VIUDO, UNION_CONVIVENCIAL
  nacionalidad       String?   @default("Argentina")
  direccion          String?
  ciudad             String?
  provincia          String?
  codigoPostal       String?
  telefono           String?
  email              String?
  contactoEmergencia String?
  telefonoEmergencia String?

  // Datos laborales
  fechaIngreso   DateTime
  fechaEgreso    DateTime?
  estado         EstadoEmpleado @default(ACTIVO)
  cargo          String
  departamento   String? // OPERACIONES, ADMINISTRACION, COMERCIAL, TALLER
  tipoContrato   TipoContrato   @default(TIEMPO_INDETERMINADO)
  jornadaLaboral String? // COMPLETA, PARCIAL
  horasSemanales Int?           @default(48)

  // Datos salariales
  salarioBasico Float
  categoriaCCT  String? // Categoría del convenio colectivo
  obraSocial    String?
  sindicato     String?
  nroAfiliado   String?
  cbu           String?
  banco         String?

  // Documentación
  altaAFIP      Boolean   @default(false)
  fechaAltaAFIP DateTime?
  artContratada String? // Nombre de la ART
  nroART        String?

  imagen String?
  notas  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  recibos    ReciboSueldo[]
  ausencias  Ausencia[]
  documentos DocumentoEmpleado[]

  @@index([estado])
  @@index([dni])
}

model ReciboSueldo {
  id         String   @id @default(cuid())
  visibleId  String   @unique @default(cuid())
  empleadoId String
  empleado   Empleado @relation(fields: [empleadoId], references: [id])

  // Período
  mes  Int // 1-12
  anio Int
  tipo TipoRecibo @default(MENSUAL) // MENSUAL, SAC_1, SAC_2, FINAL, VACACIONES

  // Haberes (conceptos que suman)
  salarioBasico Float
  presentismo   Float @default(0)
  antiguedad    Float @default(0)
  horasExtra50  Float @default(0)
  horasExtra100 Float @default(0)
  adicionales   Float @default(0)
  totalHaberes  Float

  // Deducciones (conceptos que restan)
  jubilacion        Float @default(0) // 11%
  obraSocial        Float @default(0) // 3%
  sindicato         Float @default(0) // 2-3%
  ley19032          Float @default(0) // 3% PAMI/INSSJP
  impuestoGanancias Float @default(0)
  otrasDeduccciones Float @default(0)
  totalDeducciones  Float

  // Aportes patronales (no descuento al empleado, costo empresa)
  aporteJubilacion       Float @default(0) // 16%
  aporteObraSocial       Float @default(0) // 6%
  aportePAMI             Float @default(0) // 1.5%
  aporteART              Float @default(0)
  seguroVida             Float @default(0)
  totalAportesPatronales Float

  // Neto
  netoAPagar Float

  // Estado
  estado    EstadoRecibo @default(BORRADOR)
  fechaPago DateTime?

  pdfUrl String?
  notas  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([empleadoId])
  @@index([mes, anio])
  @@index([estado])
}

model Ausencia {
  id          String       @id @default(cuid())
  empleadoId  String
  empleado    Empleado     @relation(fields: [empleadoId], references: [id])
  tipo        TipoAusencia
  fechaInicio DateTime
  fechaFin    DateTime
  dias        Int
  justificada Boolean      @default(false)
  certificado String?
  notas       String?
  estado      String       @default("PENDIENTE") // PENDIENTE, APROBADA, RECHAZADA
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@index([empleadoId])
  @@index([fechaInicio, fechaFin])
}

model DocumentoEmpleado {
  id         String   @id @default(cuid())
  empleadoId String
  empleado   Empleado @relation(fields: [empleadoId], references: [id], onDelete: Cascade)
  tipo       String // DNI, CUIL, CONTRATO, ALTA_AFIP, ART, CV, CERTIFICADO, OTRO
  nombre     String
  url        String?
  notas      String?
  createdAt  DateTime @default(now())

  @@index([empleadoId])
}

enum EstadoEmpleado {
  ACTIVO
  LICENCIA
  SUSPENDIDO
  BAJA
}

enum TipoContrato {
  TIEMPO_INDETERMINADO
  PLAZO_FIJO
  EVENTUAL
  TEMPORADA
  PASANTIA
}

enum TipoRecibo {
  MENSUAL
  SAC_1
  SAC_2
  FINAL
  VACACIONES
}

enum TipoAusencia {
  VACACIONES
  ENFERMEDAD
  ACCIDENTE_LABORAL
  LICENCIA_MATERNIDAD
  LICENCIA_PATERNIDAD
  ESTUDIO
  MATRIMONIO
  FALLECIMIENTO_FAMILIAR
  MUDANZA
  DONACION_SANGRE
  INJUSTIFICADA
  OTRO
}

enum EstadoRecibo {
  BORRADOR
  CONFIRMADO
  PAGADO
  ANULADO
}

// ─── Auditoría y Controles Internos ─────────────────────────────────────────

model AuditLog {
  id             String   @id @default(cuid())
  entidad        String   // "FacturaCompra", "AsientoContable", "Empleado", etc
  entidadId      String   // ID del registro
  accion         String   // "CREAR", "EDITAR", "ELIMINAR", "CAMBIO_ESTADO", "APROBAR", "RECHAZAR"
  campo          String?  // qué campo cambió
  valorAnterior  String?  // valor viejo (JSON)
  valorNuevo     String?  // valor nuevo (JSON)
  usuarioId      String
  usuario        User     @relation(fields: [usuarioId], references: [id])
  ip             String?
  userAgent      String?
  facturaCompra  FacturaCompra? @relation(fields: [facturaCompraId], references: [id])
  facturaCompraId String?
  createdAt      DateTime @default(now())

  @@index([entidad, entidadId])
  @@index([usuarioId])
  @@index([createdAt])
}

model PeriodoContable {
  id          String    @id @default(cuid())
  mes         Int       // 1-12
  anio        Int
  cerrado     Boolean   @default(false)
  cerradoPor  String?
  cerrador    User?     @relation(fields: [cerradoPor], references: [id])
  fechaCierre DateTime?
  motivo      String?   // Por qué se cerró
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([mes, anio])
  @@index([cerrado])
}

model DiagnosticoRun {
  id           String   @id @default(cuid())
  fecha        DateTime @default(now())
  duracion     Int      // segundos que tardó
  totalChecks  Int
  passed       Int
  warnings     Int
  errors       Int
  resultados   Json     // array con todos los checks
  ejecutadoPor String
  ejecutador   User     @relation(fields: [ejecutadoPor], references: [id])
  createdAt    DateTime @default(now())

  @@index([fecha])
  @@index([ejecutadoPor])
}

// ─── Gestión de Flota ───────────────────────────────────────────────────────

model Amortizacion {
  id                  String   @id @default(cuid())
  motoId              String
  moto                Moto     @relation(fields: [motoId], references: [id], onDelete: Cascade)
  periodo             String   // "2026-01"
  anioNumero          Int
  valorInicio         Float
  cuotaAmortizacion   Float
  amortizacionAcum    Float
  valorResidualActual Float
  createdAt           DateTime @default(now())

  @@unique([motoId, periodo])
  @@index([motoId])
  @@index([periodo])
}

model DocumentoMoto {
  id               String    @id @default(cuid())
  motoId           String
  moto             Moto      @relation(fields: [motoId], references: [id], onDelete: Cascade)
  tipo             String    // CEDULA_VERDE, CEDULA_AZUL, TITULO, POLIZA, VTV, DESPACHO_IMPORTACION, FACTURA_COMPRA, VERIFICACION_POLICIAL, FORMULARIO_01, FORMULARIO_12, CERTIFICADO_IMPORTACION
  nombre           String
  url              String?
  fechaEmision     DateTime?
  fechaVencimiento DateTime?
  notas            String?
  completado       Boolean   @default(false) // Para checklist patentamiento
  createdAt        DateTime  @default(now())

  @@index([motoId])
  @@index([tipo])
}

model HistorialEstadoMoto {
  id             String   @id @default(cuid())
  motoId         String
  moto           Moto     @relation(fields: [motoId], references: [id], onDelete: Cascade)
  estadoAnterior String
  estadoNuevo    String
  motivo         String?
  usuarioId      String?
  usuario        User?    @relation(fields: [usuarioId], references: [id])
  createdAt      DateTime @default(now())

  @@index([motoId])
  @@index([createdAt])
}

model BajaMoto {
  id              String   @id @default(cuid())
  motoId          String   @unique
  moto            Moto     @relation(fields: [motoId], references: [id], onDelete: Cascade)
  tipoBaja        String   // ROBO, SINIESTRO, VENTA
  fechaBaja       DateTime
  motivo          String?

  // ─── ROBO ───────────────────────────────────────────────────────────────
  numeroDenuncia  String?
  comisaria       String?
  fechaDenuncia   DateTime?

  // ─── SINIESTRO ──────────────────────────────────────────────────────────
  numeroSiniestro String?
  aseguradora     String?
  montoIndemnizacion Float?
  fechaSiniestro  DateTime?

  // ─── VENTA ──────────────────────────────────────────────────────────────
  compradorNombre String?
  compradorDNI    String?
  compradorTelefono String?
  precioVenta     Float?
  formaPago       String? // EFECTIVO, TRANSFERENCIA, CHEQUE

  // ─── Documentación ──────────────────────────────────────────────────────
  archivoUrl      String?
  notas           String?

  registradoPor   String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([motoId])
  @@index([tipoBaja])
  @@index([fechaBaja])
}

model NotaCredito {
  id                String   @id @default(cuid())
  numero            String   @unique // Auto-generado NC-0001
  tipo              String   // DEVOLUCION_TOTAL, DEVOLUCION_PARCIAL, DESCUENTO, AJUSTE_PRECIO
  facturaOriginalId String?
  clienteId         String
  cliente           Cliente  @relation(fields: [clienteId], references: [id])
  monto             Float
  montoNeto         Float?
  montoIva          Float?
  motivo            String
  estado            String   @default("EMITIDA") // EMITIDA, APLICADA, REEMBOLSADA, ANULADA
  aplicadaAId       String?  // Factura/pago donde se aplicó
  fechaEmision      DateTime @default(now())
  fechaAplicacion   DateTime?
  creadoPor         String?
  creador           User?    @relation(fields: [creadoPor], references: [id])
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([clienteId])
  @@index([estado])
  @@index([numero])
}

// ==========================================
// SISTEMA DE MANTENIMIENTOS - MÓDULO COMPLETO
// ==========================================

// ─── PLANES DE MANTENIMIENTO (Templates) ──────────────────────────────────

model PlanMantenimiento {
  id              String   @id @default(cuid())
  nombre          String   // "Service Básico", "Service Intermedio", "Service Mayor"
  tipo            TipoService  // BASICO, INTERMEDIO, MAYOR
  descripcion     String?
  kmDesde         Int      // Rango de km donde aplica este plan (ej: 0)
  kmHasta         Int      // (ej: 4999 para básico)
  activo          Boolean  @default(true)

  tareas          TareaPlan[]
  ordenesTrabajo  OrdenTrabajo[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

enum TipoService {
  BASICO
  INTERMEDIO
  MAYOR
}

model TareaPlan {
  id              String   @id @default(cuid())
  planId          String
  plan            PlanMantenimiento @relation(fields: [planId], references: [id], onDelete: Cascade)

  nombre          String   // "Cambio de aceite motor"
  descripcion     String?  // Instrucciones detalladas
  categoria       CategoriaTarea  // MOTOR, FRENOS, TRANSMISION, ELECTRICO, NEUMATICOS, GENERAL
  orden           Int      // Orden de ejecución dentro del plan
  obligatoria     Boolean  @default(true)
  tiempoEstimado  Int?     // Minutos estimados

  // Repuesto sugerido para esta tarea
  repuestoSugeridoId String?
  repuestoSugerido   Repuesto? @relation(fields: [repuestoSugeridoId], references: [id])
  cantidadRepuesto   Float?    // Cantidad del repuesto (ej: 0.8 litros de aceite)

  tareasOT           TareaOrdenTrabajo[]
  repuestosTareaPlan RepuestoTareaPlan[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

enum CategoriaTarea {
  MOTOR
  FRENOS
  TRANSMISION
  ELECTRICO
  NEUMATICOS
  SUSPENSION
  CARROCERIA
  GENERAL
}

// ─── CITAS DE MANTENIMIENTO ──────────────────────────────────────

model CitaMantenimiento {
  id              String   @id @default(cuid())
  motoId          String
  moto            Moto     @relation(fields: [motoId], references: [id])
  riderId         String?  // Cliente/rider asignado a la moto
  rider           Cliente? @relation(fields: [riderId], references: [id])

  // Programación
  fechaProgramada DateTime // Fecha y hora programada
  fechaOriginal   DateTime // Fecha original (antes de reprogramaciones)
  lugarId         String?  // Taller asignado
  lugar           Taller?  @relation(fields: [lugarId], references: [id])

  // Estado
  estado          EstadoCita @default(PROGRAMADA)
  motivoReprogramacion String? // Si el rider pidió cambio
  motivoInasistencia   String? // Si no se presentó
  vecesReprogramada    Int     @default(0)
  maxReprogramaciones  Int     @default(2) // Máximo de veces que puede reprogramar

  // QR
  codigoQR        String   @unique @default(cuid()) // Código único para generar QR
  qrEscaneado     Boolean  @default(false)
  qrEscaneadoAt   DateTime?
  qrEscaneadoPor  String?  // Usuario que escaneó

  // Vinculación con la OT que se genera
  ordenTrabajoId  String?  @unique
  ordenTrabajo    OrdenTrabajo? @relation(fields: [ordenTrabajoId], references: [id])

  // Notificaciones
  notificacion7dias  Boolean @default(false) // Se envió notif 7 días antes
  notificacion3dias  Boolean @default(false) // Se envió notif 3 días antes
  notificacion1dia   Boolean @default(false) // Se envió notif 1 día antes
  notificacionDia    Boolean @default(false) // Se envió notif el mismo día

  notificaciones  NotificacionMantenimiento[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([motoId, estado])
  @@index([fechaProgramada])
  @@index([estado])
}

enum EstadoCita {
  PROGRAMADA           // Sistema la creó automáticamente
  NOTIFICADA           // Se envió notificación al rider
  CONFIRMADA           // Rider confirmó asistencia
  REPROGRAMADA         // Rider solicitó cambio (nueva fecha asignada)
  EN_PROCESO           // Rider hizo check-in, moto en taller
  COMPLETADA           // Service terminado, check-out hecho
  NO_ASISTIO           // Rider no se presentó
  CANCELADA            // Cancelada por admin
}

// ─── ORDENES DE TRABAJO ──────────────────────────────────────

model OrdenTrabajo {
  id              String   @id @default(cuid())
  numero          String   @unique // Auto-generado: OT-2026-00001

  motoId          String
  moto            Moto     @relation(fields: [motoId], references: [id])
  riderId         String?
  rider           Cliente? @relation("OrdenTrabajoRider", fields: [riderId], references: [id])

  // Tipo y plan
  tipoOT          TipoOT // PREVENTIVO, CORRECTIVO, EMERGENCIA
  prioridad       PrioridadOT       @default(MEDIA)
  planId          String?
  plan            PlanMantenimiento? @relation(fields: [planId], references: [id])
  tipoService     TipoService?      // BASICO, INTERMEDIO, MAYOR (determinado por km)

  // Estado
  estado          EstadoOT @default(SOLICITADA)

  // Kilometraje
  kmAlIngreso     Int      // Km de la moto al momento del check-in
  kmAlEgreso      Int?     // Km al salir (debería ser igual o muy similar)

  // Taller y mecánico
  tallerId        String?
  taller          Taller?  @relation(fields: [tallerId], references: [id])
  mecanicoId      String?
  mecanico        Mecanico? @relation(fields: [mecanicoId], references: [id])
  esExterno       Boolean  @default(false) // Taller externo o interno

  // Tiempos
  fechaProgramada DateTime?
  fechaIngreso    DateTime? // Check-in real
  fechaInicioTrabajo DateTime?
  fechaFinTrabajo DateTime?
  fechaEgreso     DateTime? // Check-out real
  tiempoInactividadHoras Float? // Calculado: fechaEgreso - fechaIngreso

  // Descripción
  descripcion     String?  // Descripción del problema (para correctivos)
  observacionesMecanico String? // Notas del mecánico al cerrar
  observacionesRecepcion String? // Notas de recepción

  // Costos
  costoRepuestos  Float    @default(0)
  costoManoObra   Float    @default(0)
  costoOtros      Float    @default(0) // Flete, grúa, etc.
  costoTotal      Float    @default(0) // Calculado
  costoACargoDel  ResponsableCosto @default(EMPRESA)

  // Detección de problema mayor
  problemaDetectado Boolean @default(false)
  descripcionProblema String?
  requiereReparacion  Boolean @default(false)
  ordenReparacionId   String? // Si genera una OT de reparación aparte

  // Puntaje del rider
  puntajeEstadoMoto    Float?  // 0-100 basado en fotos de check-in
  detallesPuntaje      Json?   // Detalle del análisis de Claude Vision

  // Relaciones
  cita            CitaMantenimiento?
  tareas          TareaOrdenTrabajo[]
  repuestosUsados RepuestoOrdenTrabajo[]
  fotosCheckIn    FotoInspeccion[]  @relation("FotosCheckIn")
  fotosCheckOut   FotoInspeccion[]  @relation("FotosCheckOut")
  historial       HistorialOT[]
  puntajes        PuntajeRider[]

  // Firma/aceptación del rider
  riderAceptoEntrega Boolean @default(false)
  riderAceptoAt      DateTime?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([motoId])
  @@index([estado])
  @@index([tipoOT])
  @@index([fechaIngreso])
}

enum TipoOT {
  PREVENTIVO
  CORRECTIVO
  EMERGENCIA
}

enum PrioridadOT {
  BAJA
  MEDIA
  ALTA
  URGENTE
}

enum EstadoOT {
  SOLICITADA          // Creada, pendiente de evaluación
  APROBADA            // Validada, lista para planificación
  PROGRAMADA          // Con fecha y recursos confirmados
  EN_ESPERA_REPUESTOS // Bloqueada por falta de stock
  EN_EJECUCION        // Trabajo en curso
  EN_REVISION         // Pendiente control de calidad
  COMPLETADA          // Verificada y cerrada
  CANCELADA           // Cancelada
}

enum ResponsableCosto {
  EMPRESA  // Costo a cargo de MotoLibre (desgaste normal, preventivo)
  RIDER    // Costo a cargo del rider (accidente, mal uso)
  COMPARTIDO // Costo compartido
}

// ─── TAREAS DENTRO DE UNA OT ──────────────────────────────────────

model TareaOrdenTrabajo {
  id              String   @id @default(cuid())
  ordenTrabajoId  String
  ordenTrabajo    OrdenTrabajo @relation(fields: [ordenTrabajoId], references: [id], onDelete: Cascade)

  tareaPlanId     String?  // Referencia a la tarea del plan (si es preventivo)
  tareaPlan       TareaPlan? @relation(fields: [tareaPlanId], references: [id])

  nombre          String
  descripcion     String?
  categoria       CategoriaTarea
  orden           Int
  obligatoria     Boolean  @default(true)

  // Ejecución
  completada      Boolean  @default(false)
  completadaAt    DateTime?
  completadaPor   String?  // Mecánico que la ejecutó
  observaciones   String?
  resultado       ResultadoTarea? // APROBADO, REQUIERE_ATENCION, REPROBADO

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

enum ResultadoTarea {
  APROBADO
  REQUIERE_ATENCION
  REPROBADO
}

// ─── REPUESTOS USADOS EN UNA OT ──────────────────────────────────────

model RepuestoOrdenTrabajo {
  id              String   @id @default(cuid())
  ordenTrabajoId  String
  ordenTrabajo    OrdenTrabajo @relation(fields: [ordenTrabajoId], references: [id], onDelete: Cascade)

  repuestoId      String
  repuesto        Repuesto @relation(fields: [repuestoId], references: [id])

  cantidadPlanificada Float  // Lo que se esperaba usar
  cantidadUsada       Float  @default(0) // Lo que realmente se usó
  costoUnitario       Float  @default(0)
  costoTotal          Float  @default(0) // cantidadUsada * costoUnitario

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([ordenTrabajoId, repuestoId])
}

// ─── REPUESTOS VINCULADOS A TAREAS DE PLAN ──────────────────────────────────────

model RepuestoTareaPlan {
  id              String   @id @default(cuid())
  tareaPlanId     String
  tareaPlan       TareaPlan @relation(fields: [tareaPlanId], references: [id], onDelete: Cascade)
  repuestoId      String
  repuesto        Repuesto @relation(fields: [repuestoId], references: [id])
  cantidad        Float    @default(1) // Cantidad requerida del repuesto
  tipoConsumo     TipoConsumoRepuesto @default(PLANIFICADO)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([tareaPlanId, repuestoId])
}

enum TipoConsumoRepuesto {
  PLANIFICADO   // Siempre se usa en este service
  CONDICIONAL   // Se usa solo si se detecta desgaste
  EXTRA         // Repuesto adicional no planificado
}

// ─── FOTOS DE INSPECCIÓN ──────────────────────────────────────

model FotoInspeccion {
  id              String   @id @default(cuid())

  // Vinculación (check-in o check-out)
  ordenTrabajoCheckInId  String?
  ordenTrabajoCheckIn    OrdenTrabajo? @relation("FotosCheckIn", fields: [ordenTrabajoCheckInId], references: [id])
  ordenTrabajoCheckOutId String?
  ordenTrabajoCheckOut   OrdenTrabajo? @relation("FotosCheckOut", fields: [ordenTrabajoCheckOutId], references: [id])

  tipo            TipoFoto // FRENTE, LATERAL_IZQ, LATERAL_DER, TRASERA, TABLERO, NEUMATICO_DEL, NEUMATICO_TRAS
  url             String   // URL en Cloudflare R2

  // Análisis de Claude Vision
  analizado       Boolean  @default(false)
  analisisResultado Json?  // Resultado completo del análisis
  kmDetectado     Int?     // Km leído del tablero (solo para tipo TABLERO)
  nivelDesgasteNeumatico Float? // 0-100% (solo para NEUMATICO_DEL y NEUMATICO_TRAS)
  danoDetectado   Boolean? // Si se detectó golpe/accidente
  descripcionDano String?  // Descripción del daño detectado

  subidoPor       String?  // Usuario que subió la foto
  subidoAt        DateTime @default(now())

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([ordenTrabajoCheckInId])
  @@index([ordenTrabajoCheckOutId])
}

enum TipoFoto {
  FRENTE
  LATERAL_IZQ
  LATERAL_DER
  TRASERA
  TABLERO
  NEUMATICO_DEL
  NEUMATICO_TRAS
}

// ─── TALLERES Y MECÁNICOS ──────────────────────────────────────

model Taller {
  id              String   @id @default(cuid())
  nombre          String
  direccion       String?
  telefono        String?
  email           String?
  tipo            TipoTaller // INTERNO, EXTERNO
  activo          Boolean  @default(true)

  // Capacidad
  capacidadDiaria Int      @default(10) // Cantidad de motos que puede atender por día
  horarioApertura String?  // "08:00"
  horarioCierre   String?  // "18:00"
  diasOperacion   String[] // ["LUN","MAR","MIE","JUE","VIE","SAB"]

  mecanicos       Mecanico[]
  citas           CitaMantenimiento[]
  ordenesTrabajo  OrdenTrabajo[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

enum TipoTaller {
  INTERNO
  EXTERNO
}

model Mecanico {
  id              String   @id @default(cuid())
  nombre          String
  telefono        String?
  email           String?
  especialidad    String?  // "Motor", "Electricidad", "General"
  tallerId        String
  taller          Taller   @relation(fields: [tallerId], references: [id])
  activo          Boolean  @default(true)
  tarifaHora      Float?   // Tarifa por hora (para talleres internos)

  ordenesTrabajo  OrdenTrabajo[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// ─── HISTORIAL DE CAMBIOS EN OT ──────────────────────────────────────

model HistorialOT {
  id              String   @id @default(cuid())
  ordenTrabajoId  String
  ordenTrabajo    OrdenTrabajo @relation(fields: [ordenTrabajoId], references: [id], onDelete: Cascade)

  estadoAnterior  String?
  estadoNuevo     String
  accion          String   // "Creación", "Check-in", "Inicio trabajo", "Check-out", etc.
  detalle         String?
  realizadoPor    String?  // Usuario que realizó la acción

  createdAt       DateTime @default(now())
}

// ─── PUNTAJE DEL RIDER ──────────────────────────────────────

model PuntajeRider {
  id              String   @id @default(cuid())
  riderId         String
  rider           Cliente  @relation(fields: [riderId], references: [id])

  ordenTrabajoId  String
  ordenTrabajo    OrdenTrabajo @relation(fields: [ordenTrabajoId], references: [id])

  // Componentes del puntaje (0-100 cada uno)
  puntajeEstadoGeneral   Float  // Basado en análisis de fotos (carrocería)
  puntajeNeumaticos      Float  // Basado en análisis de desgaste
  puntajeAsistencia      Float  // 100 si asistió a tiempo, 50 si reprogramó, 0 si no asistió
  puntajeKmCoherente     Float  // Km del tablero vs km IoT (detecta manipulación)
  puntajeSinAccidentes   Float  // 100 si no hay daños nuevos, menos según gravedad

  puntajeTotal           Float  // Promedio ponderado

  observaciones          String?

  createdAt              DateTime @default(now())

  @@index([riderId])
}

// ─── LECTURAS DE KM (IoT) ──────────────────────────────────────

model LecturaKm {
  id              String   @id @default(cuid())
  motoId          String
  moto            Moto     @relation(fields: [motoId], references: [id])

  km              Int
  fuente          FuenteKm // IOT, MANUAL, FOTO (Claude Vision)

  createdAt       DateTime @default(now())

  @@index([motoId, createdAt])
}

enum FuenteKm {
  IOT
  MANUAL
  FOTO
}

// ─── NOTIFICACIONES DE MANTENIMIENTO ──────────────────────────────────────

model NotificacionMantenimiento {
  id        String   @id @default(cuid())
  citaId    String
  cita      CitaMantenimiento @relation(fields: [citaId], references: [id])
  tipo      String   // "7_DIAS", "3_DIAS", "1_DIA", "DIA", "NO_ASISTIO"
  canal     String   // "EMAIL", "PUSH", "SMS", "SISTEMA"
  enviada   Boolean  @default(false)
  enviadaAt DateTime?
  error     String?

  createdAt DateTime @default(now())
}

// ==========================================
// GESTIÓN DE INVENTARIO V2
// ==========================================

// ─── UBICACIONES EN DEPÓSITO ────────────────────────────────────

model UbicacionDeposito {
  id        String   @id @default(cuid())
  codigo    String   @unique // "E2-F3-P1" (Estante 2, Fila 3, Posición 1)
  estante   String   // "E2"
  fila      String   // "F3"
  posicion  String   // "P1"
  nombre    String?  // "Estante Frenos", alias legible
  notas     String?
  activo    Boolean  @default(true)
  createdAt DateTime @default(now())
}

// ─── MOVIMIENTOS DE STOCK ───────────────────────────────────────

model MovimientoStock {
  id            String              @id @default(cuid())
  repuestoId    String
  repuesto      Repuesto            @relation(fields: [repuestoId], references: [id])
  tipo          TipoMovimientoStock
  cantidad      Int                 // Positivo = entrada, Negativo = salida
  stockAnterior Int                 // Stock antes del movimiento
  stockNuevo    Int                 // Stock después del movimiento
  motivo        String?             // "Recepción OC-001", "Consumo OT-045", "Ajuste inventario", "Importación CSV"
  referencia    String?             // ID de la OC, OT, o recepción que originó el movimiento
  usuario       String?             // Email del usuario que hizo el movimiento
  createdAt     DateTime            @default(now())

  @@index([repuestoId])
  @@index([createdAt])
}

enum TipoMovimientoStock {
  ENTRADA_COMPRA       // Llegó mercadería de una OC
  ENTRADA_AJUSTE       // Ajuste manual positivo (inventario)
  ENTRADA_DEVOLUCION   // Devolvieron un repuesto de una OT
  SALIDA_CONSUMO_OT    // Se usó en una Orden de Trabajo
  SALIDA_AJUSTE        // Ajuste manual negativo (inventario)
  SALIDA_ROTURA        // Se rompió o venció
  IMPORTACION          // Carga masiva desde CSV/Excel
}

// ─── ORDENES DE COMPRA ──────────────────────────────────────────

model OrdenCompra {
  id                   String            @id @default(cuid())
  visibleId            String            @unique @default(cuid())
  numero               String            @unique // "OC-001" autogenerado
  proveedorId          String
  proveedor            Proveedor         @relation(fields: [proveedorId], references: [id])
  estado               EstadoOrdenCompra @default(BORRADOR)
  fechaEmision         DateTime          @default(now())
  fechaEntregaEstimada DateTime?
  subtotal             Float             @default(0)
  iva                  Float             @default(0)
  total                Float             @default(0)
  notas                String?
  creadoPor            String?           // Email del usuario
  aprobadoPor          String?
  createdAt            DateTime          @default(now())
  updatedAt            DateTime          @updatedAt
  items                ItemOrdenCompra[]
  recepciones          RecepcionMercaderia[]
}

enum EstadoOrdenCompra {
  BORRADOR       // Se está armando
  PENDIENTE      // Enviada al proveedor, esperando
  PARCIAL        // Recibida parcialmente
  COMPLETADA     // Todo recibido
  CANCELADA      // Cancelada
}

model ItemOrdenCompra {
  id               String      @id @default(cuid())
  ordenCompraId    String
  ordenCompra      OrdenCompra @relation(fields: [ordenCompraId], references: [id], onDelete: Cascade)
  repuestoId       String
  repuesto         Repuesto    @relation(fields: [repuestoId], references: [id])
  cantidad         Int         // Cantidad pedida
  cantidadRecibida Int         @default(0) // Cantidad ya recibida (se actualiza con recepciones)
  precioUnitario   Float       @default(0)
  subtotal         Float       @default(0) // cantidad × precioUnitario
  createdAt        DateTime    @default(now())

  @@unique([ordenCompraId, repuestoId])
}

// ─── RECEPCIÓN DE MERCADERÍA ────────────────────────────────────

model RecepcionMercaderia {
  id             String            @id @default(cuid())
  visibleId      String            @unique @default(cuid())
  ordenCompraId  String?           // Puede ser recepción sin OC (ingreso directo)
  ordenCompra    OrdenCompra?      @relation(fields: [ordenCompraId], references: [id])
  numero         String            @unique // "REC-001"
  fechaRecepcion DateTime          @default(now())
  recibidoPor    String?           // Email
  notas          String?
  createdAt      DateTime          @default(now())
  items          ItemRecepcion[]
}

model ItemRecepcion {
  id                String              @id @default(cuid())
  recepcionId       String
  recepcion         RecepcionMercaderia @relation(fields: [recepcionId], references: [id], onDelete: Cascade)
  repuestoId        String
  repuesto          Repuesto            @relation(fields: [repuestoId], references: [id])
  cantidadEsperada  Int?                // Lo que decía la OC (null si es ingreso directo)
  cantidadRecibida  Int                 // Lo que realmente llegó
  cantidadRechazada Int                 @default(0) // Defectuosos / dañados
  ubicacionAsignada String?             // "E2-F3-P1" — dónde se guardó
  observaciones     String?
  createdAt         DateTime            @default(now())
}

// ==========================================
// COSTEO DE IMPORTACIÓN Y PRICING
// ==========================================

// ─── CONFIGURACIÓN DE CATEGORÍA ─────────────────────────────────

model CategoriaRepuestoConfig {
  id              String   @id @default(cuid())
  categoria       String   @unique // "FRENOS", "MOTOR", "FILTROS", etc.
  nombre          String   // Nombre legible
  margenObjetivo  Float    @default(0.45) // 45% margen objetivo
  margenMinimo    Float    @default(0.25) // 25% margen mínimo
  markupDefault   Float    @default(1.8)  // Multiplicador default (1.8x = 80% markup)
  arancelImpo     Float    @default(0.16) // 16% arancel para esta categoría
  ncmDefault      String?  // NCM default para la categoría
  notas           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// ─── EMBARQUES DE IMPORTACIÓN ───────────────────────────────────

model EmbarqueImportacion {
  id                  String              @id @default(cuid())
  visibleId           String              @unique @default(cuid())
  referencia          String              @unique // "EMB-001" autogenerado
  proveedorId         String
  proveedor           Proveedor           @relation(fields: [proveedorId], references: [id])
  estado              EstadoEmbarque      @default(BORRADOR)
  metodoFlete         MetodoFlete

  // Fechas
  fechaSalida         DateTime?           // ETD
  fechaLlegadaEstimada DateTime?          // ETA
  fechaLlegadaReal    DateTime?

  // Contenedor
  numeroContenedor    String?
  tipoContenedor      String?             // "20GP", "40GP", "40HQ"

  // ─── Costos compartidos en USD ────────────────────────────────
  totalFobUsd         Float               @default(0)
  fleteUsd            Float               @default(0)
  seguroUsd           Float               @default(0)
  cifUsd              Float               @default(0) // FOB + Flete + Seguro

  // ─── Impuestos de aduana (calculados) ─────────────────────────
  derechosImportacion Float?   // DIE — NO recuperable
  tasaEstadistica     Float?   // 3% — NO recuperable
  ivaAduana           Float?   // 21% — RECUPERABLE (crédito fiscal)
  ivaAdicional        Float?   // 20% — RECUPERABLE
  gananciasAnticipado Float?   // 6% — RECUPERABLE
  iibbAnticipado      Float?   // ~3% — RECUPERABLE
  tasaOficializacion  Float?   // USD $10 fijo — NO recuperable
  tasaDigitalizacion  Float?   // USD $28 fijo — NO recuperable

  // ─── Gastos logísticos en USD ─────────────────────────────────
  despachanteFee      Float?   // Honorarios despachante
  gastosPuerto        Float?   // Terminal, almacenaje, etc
  transporteInterno   Float?   // Flete interno hasta depósito
  otrosGastos         Float?   // Otros gastos no categorizados
  otrosGastosDetalle  String?  // Descripción de otros gastos

  // ─── Tipo de cambio ───────────────────────────────────────────
  tipoCambioArsUsd    Float?   // TC Banco Nación vendedor al momento del despacho
  fechaDespacho       DateTime?
  numeroDespacho      String?  // Número de despacho aduanero

  // ─── Totales calculados ───────────────────────────────────────
  costoTotalNoRecuperable Float?  // Todo lo que suma al costo del inventario
  costoTotalRecuperable   Float?  // IVA + Ganancias + IIBB (crédito fiscal)
  desembolsoTotal         Float?  // Total que se paga en aduana

  // ─── Cantidad de despachos parciales ──────────────────────────
  cantidadDespachos       Int     @default(1)

  notas               String?

  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  items                ItemEmbarque[]
  despachos            DespachoAduanero[]
  asignaciones         AsignacionCostoImportacion[]
}

enum EstadoEmbarque {
  BORRADOR
  EN_TRANSITO
  EN_PUERTO
  EN_ADUANA
  DESPACHADO_PARCIAL
  RECIBIDO
  COSTO_FINALIZADO
}

enum MetodoFlete {
  MARITIMO_FCL    // Contenedor completo
  MARITIMO_LCL   // Carga consolidada
  AEREO           // Avión
}

// ─── ITEMS DEL EMBARQUE ─────────────────────────────────────────

model ItemEmbarque {
  id              String             @id @default(cuid())
  embarqueId      String
  embarque        EmbarqueImportacion @relation(fields: [embarqueId], references: [id], onDelete: Cascade)
  repuestoId      String
  repuesto        Repuesto           @relation(fields: [repuestoId], references: [id])

  cantidad        Int                // Cantidad importada
  precioFobUnitarioUsd Float         // Precio FOB por unidad en USD
  subtotalFobUsd  Float              // cantidad × precioFobUnitario
  pesoTotalKg     Float?             // Peso total de esta línea
  volumenTotalCbm Float?             // Volumen total de esta línea
  ncmCodigo       String?            // NCM específico (override del repuesto)
  arancelPorcentaje Float?           // % arancel específico (override de categoría)

  // ─── Costos asignados (se calculan al finalizar) ──────────────
  costoAsignadoFlete    Float?       // Flete prorrateado a esta línea
  costoAsignadoSeguro   Float?
  costoAsignadoDerechos Float?
  costoAsignadoTasas    Float?
  costoAsignadoLogistica Float?

  costoLandedUnitarioUsd Float?      // Costo puesto en almacén por unidad (USD)
  costoLandedUnitarioArs Float?      // Costo puesto en almacén por unidad (ARS)

  createdAt       DateTime           @default(now())

  @@unique([embarqueId, repuestoId])
}

// ─── DESPACHOS ADUANEROS (parciales) ────────────────────────────

model DespachoAduanero {
  id                  String             @id @default(cuid())
  embarqueId          String
  embarque            EmbarqueImportacion @relation(fields: [embarqueId], references: [id])
  numeroDespacho      String             @unique
  fecha               DateTime
  tipoCambio          Float              // TC BNA vendedor en la fecha
  cifParcialUsd       Float              // CIF de lo despachado en este despacho
  derechosPagados     Float              @default(0)
  tasaEstadistica     Float              @default(0)
  ivaPagado           Float              @default(0)
  ivaAdicionalPagado  Float              @default(0)
  gananciasPagado     Float              @default(0)
  iibbPagado          Float              @default(0)
  tasaOficializacion  Float              @default(10)  // USD 10
  tasaDigitalizacion  Float              @default(28)  // USD 28
  gastosDespachante   Float?
  otrosGastos         Float?
  notas               String?

  // Items despachados en este despacho parcial
  itemsDespachados    Json?              // [{ repuestoId, cantidad }]

  createdAt           DateTime           @default(now())

  @@index([embarqueId])
}

// ─── ASIGNACIÓN DE COSTOS POR REPUESTO ──────────────────────────

model AsignacionCostoImportacion {
  id                  String             @id @default(cuid())
  embarqueId          String
  embarque            EmbarqueImportacion @relation(fields: [embarqueId], references: [id])
  repuestoId          String
  repuesto            Repuesto           @relation(fields: [repuestoId], references: [id])

  cantidad            Int
  fobUnitarioUsd      Float
  fleteUnitarioUsd    Float
  seguroUnitarioUsd   Float
  derechosUnitarioUsd Float
  tasasUnitarioUsd    Float
  logisticaUnitarioUsd Float

  // Totales por unidad
  costoLandedUnitarioUsd Float          // Solo costos no recuperables
  costoLandedUnitarioArs Float          // Convertido a ARS al TC del despacho
  desembolsoUnitarioUsd  Float          // Incluyendo recuperables (cash flow)

  metodoAsignacion    String            // "POR_VALOR", "POR_VOLUMEN", "POR_PESO", "HIBRIDO"
  tipoCambioUsado     Float

  createdAt           DateTime          @default(now())

  @@index([embarqueId])
  @@index([repuestoId])
}

// ─── HISTORIAL DE COSTOS ────────────────────────────────────────

model HistorialCostoRepuesto {
  id                  String   @id @default(cuid())
  repuestoId          String
  repuesto            Repuesto @relation(fields: [repuestoId], references: [id])

  costoAnteriorArs    Float
  costoNuevoArs       Float
  costoAnteriorUsd    Float?
  costoNuevoUsd       Float?
  cantidadAnterior    Int
  cantidadNueva       Int

  motivo              String   // "IMPORTACION", "AJUSTE_MANUAL", "CORRECCION", "RECEPCION_LOCAL"
  referencia          String?  // ID del embarque, OC, o ajuste que originó el cambio
  tipoCambio          Float?
  usuario             String?  // Email del usuario

  createdAt           DateTime @default(now())

  @@index([repuestoId, createdAt])
}

// ==========================================
// MOTOR DE PRICING — REPUESTOS
// ==========================================

// ─── LISTAS DE PRECIOS ──────────────────────────────────────────

model ListaPrecio {
  id              String           @id @default(cuid())
  nombre          String           // "B2C Retail", "Rider Activo", "Taller Externo", "Uso Interno"
  codigo          String           @unique // "B2C", "RIDER", "TALLER", "INTERNO"
  tipo            TipoListaPrecio
  moneda          String           @default("ARS")
  activa          Boolean          @default(true)
  prioridad       Int              @default(0) // Mayor prioridad = se evalúa primero
  descripcion     String?

  // Descuento global de la lista (% sobre precio retail)
  descuentoGlobalPct Float?        // Ej: 0.15 = 15% off retail

  // Vigencia opcional
  vigenciaDesde   DateTime?
  vigenciaHasta   DateTime?

  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  items           ItemListaPrecio[]
  reglasDescuento ReglaDescuento[]
  gruposCliente   GrupoCliente[]
}

enum TipoListaPrecio {
  RETAIL        // Precio público B2C (base para las demás)
  PREFERENCIAL  // Descuento para riders activos
  MAYORISTA     // Para talleres y mecánicos externos
  INTERNO       // Uso interno de la flota propia
  PERSONALIZADA // Negociación específica
}

// ─── ITEMS DE LISTA DE PRECIOS ──────────────────────────────────

model ItemListaPrecio {
  id              String       @id @default(cuid())
  listaPrecioId   String
  listaPrecio     ListaPrecio  @relation(fields: [listaPrecioId], references: [id], onDelete: Cascade)
  repuestoId      String
  repuesto        Repuesto     @relation(fields: [repuestoId], references: [id])

  precioArs       Float        // Precio final en ARS para esta lista
  precioUsd       Float?       // Precio en USD (referencial)

  // Cantidad mínima para este precio (permite escalonado)
  cantidadMinima  Int          @default(1)

  // Vigencia temporal
  vigenciaDesde   DateTime     @default(now())
  vigenciaHasta   DateTime?

  // Metadata de cálculo (para auditoría: cómo se llegó a este precio)
  costoBase       Float?       // Costo al momento de calcular
  markupAplicado  Float?       // Multiplicador aplicado
  descuentoAplicado Float?     // % de descuento aplicado
  metodoCalculo   String?      // "MARKUP_CATEGORIA", "MARKUP_BANDA", "MANUAL", "BULK_UPDATE"

  createdAt       DateTime     @default(now())

  @@unique([listaPrecioId, repuestoId, cantidadMinima, vigenciaDesde])
  @@index([listaPrecioId, repuestoId])
  @@index([vigenciaDesde, vigenciaHasta])
}

// ─── REGLAS DE MARKUP ───────────────────────────────────────────

model ReglaMarkup {
  id              String   @id @default(cuid())
  nombre          String   // "Banda $0-$5", "Banda $5-$75", etc.
  
  // Condiciones (al menos una debe aplicar)
  categoria       String?  // Si null, aplica a todas las categorías
  costoBandaDesde Float?   // Rango de costo unitario (en ARS)
  costoBandaHasta Float?
  esOEM           Boolean? // null = ambos, true = solo OEM, false = solo genérico

  // Acción
  multiplicador   Float    // Ej: 2.5 = precio = costo × 2.5
  redondeo        String?  // "NEAREST_10", "NEAREST_50", "NEAREST_99", "NONE"

  prioridad       Int      @default(0) // Mayor = se evalúa primero
  activa          Boolean  @default(true)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([categoria])
}

// ─── REGLAS DE DESCUENTO ────────────────────────────────────────

model ReglaDescuento {
  id              String       @id @default(cuid())
  nombre          String       // "Descuento Plan Premium", "Antigüedad 1+ año"
  listaPrecioId   String?      // Si null, aplica a todas las listas
  listaPrecio     ListaPrecio? @relation(fields: [listaPrecioId], references: [id])

  // ─── Condiciones ──────────────────────────────────────────────
  tipoCondicion   TipoCondicionDescuento
  
  // Para PLAN_ALQUILER: qué plan tiene el rider
  planAlquiler    String?      // "BASICO", "PREMIUM", "VIP" (match contra contrato activo)
  
  // Para ANTIGUEDAD: meses mínimos como cliente activo
  antiguedadMeses Int?         // 6, 12, 24, 60
  
  // Para CATEGORIA: aplica solo a una categoría de repuesto
  categoria       String?
  
  // Para CANTIDAD: compras mayores a X unidades
  cantidadMinima  Int?

  // ─── Acción ───────────────────────────────────────────────────
  tipoDescuento   TipoDescuento
  valorDescuento  Float        // Porcentaje (0.10 = 10%) o monto fijo en ARS

  // ─── Guardrails ───────────────────────────────────────────────
  margenMinimo    Float?       // No aplicar si el margen cae por debajo de esto
  acumulable      Boolean      @default(false) // ¿Se puede combinar con otros descuentos?

  prioridad       Int          @default(0)
  activa          Boolean      @default(true)
  vigenciaDesde   DateTime?
  vigenciaHasta   DateTime?

  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
}

enum TipoCondicionDescuento {
  PLAN_ALQUILER     // Según el plan de alquiler del rider
  ANTIGUEDAD        // Meses como cliente activo
  CATEGORIA         // Categoría de repuesto
  CANTIDAD          // Volumen de compra
  GRUPO_CLIENTE     // Pertenencia a grupo
  SIEMPRE           // Se aplica siempre (descuento de la lista)
}

enum TipoDescuento {
  PORCENTAJE        // 10% off
  MONTO_FIJO        // $500 off
}

// ─── GRUPOS DE CLIENTES ─────────────────────────────────────────

model GrupoCliente {
  id              String       @id @default(cuid())
  nombre          String       @unique // "Riders Activos", "Talleres Externos", "VIP"
  descripcion     String?
  listaPrecioId   String?      // Lista de precios asignada por defecto
  listaPrecio     ListaPrecio? @relation(fields: [listaPrecioId], references: [id])
  descuentoExtra  Float?       // Descuento adicional sobre la lista
  activo          Boolean      @default(true)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  miembros        MiembroGrupoCliente[]
}

model MiembroGrupoCliente {
  id              String       @id @default(cuid())
  grupoId         String
  grupo           GrupoCliente @relation(fields: [grupoId], references: [id], onDelete: Cascade)
  clienteId       String
  cliente         Cliente      @relation(fields: [clienteId], references: [id])
  fechaIngreso    DateTime     @default(now())

  @@unique([grupoId, clienteId])
}

// ─── HISTORIAL DE PRECIOS ───────────────────────────────────────

model HistorialPrecioRepuesto {
  id              String   @id @default(cuid())
  repuestoId      String
  repuesto        Repuesto @relation(fields: [repuestoId], references: [id])
  listaPrecioId   String?  // null = precio general (precioVenta del repuesto)

  precioAnterior  Float?
  precioNuevo     Float
  
  tipoCambio      String   // "MANUAL", "BULK_UPDATE", "RECALCULO_COSTO", "REGLA_MARKUP", "IMPORTACION"
  motivo          String?  // "Actualización por embarque EMB-003", "Ajuste inflación +15%"
  loteId          String?  // Agrupa cambios bulk (para rollback)

  // Snapshot al momento del cambio
  costoAlMomento  Float?
  margenAlMomento Float?   // (precio - costo) / precio

  usuario         String   // Email del usuario
  createdAt       DateTime @default(now())

  @@index([repuestoId, createdAt])
  @@index([loteId])
  @@index([createdAt])
}

// ─── LOTES DE CAMBIO DE PRECIO (para rollback) ─────────────────

model LoteCambioPrecio {
  id              String   @id @default(cuid())
  descripcion     String   // "Ajuste inflación Marzo 2026", "Recálculo post EMB-003"
  tipo            String   // "BULK_PORCENTAJE", "BULK_MARKUP", "RECALCULO_COSTO", "ROLLBACK"
  
  cantidadItems   Int      // Cuántos repuestos afectó
  parametros      Json?    // { porcentaje: 15, categorias: ["FRENOS", "MOTOR"] }
  
  aplicado        Boolean  @default(false) // false = preview, true = confirmado
  revertido       Boolean  @default(false) // true = se hizo rollback
  revertidoPor    String?  // Lote ID del rollback

  usuario         String
  createdAt       DateTime @default(now())
}
