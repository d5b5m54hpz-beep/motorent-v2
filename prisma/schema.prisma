generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ─── Auth ────────────────────────────────────────────────────────────────────

model User {
  id                      String             @id @default(cuid())
  email                   String             @unique
  name                    String
  image                   String?
  provider                String             // "credentials" | "google" | "apple" | "facebook"
  password                String?
  phone                   String?
  phoneVerifiedAt         DateTime?
  role                    Role               @default(CLIENTE)
  createdAt               DateTime           @default(now())
  updatedAt               DateTime           @updatedAt
  cliente                 Cliente?
  facturasAprobadas       FacturaCompra[]    @relation("FacturaAprobador")
  facturasCreadas         FacturaCompra[]    @relation("FacturaCreador")
  auditLogs               AuditLog[]
  periodosCerrados        PeriodoContable[]
  diagnosticosEjecutados  DiagnosticoRun[]
}

enum Role {
  ADMIN
  OPERADOR
  CLIENTE
  CONTADOR
  RRHH_MANAGER
  COMERCIAL
  VIEWER
}

// ─── Negocio ─────────────────────────────────────────────────────────────────

model Cliente {
  id                  String     @id @default(cuid())
  userId              String     @unique
  nombre              String?
  email               String     @unique
  telefono            String?
  dni                 String?
  dniVerificado       Boolean    @default(false)
  licencia            String?
  licenciaVencimiento DateTime?
  licenciaVerificada  Boolean    @default(false)
  direccion           String?
  ciudad              String?
  provincia           String?
  codigoPostal        String?
  fechaNacimiento     DateTime?
  notas               String?
  estado              String     @default("pendiente") // pendiente | aprobado | rechazado
  preRegistro         Json?
  aprobadoPor         String?
  aprobadoAt          DateTime?
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt
  user                User       @relation(fields: [userId], references: [id])
  contratos           Contrato[]
}

model Moto {
  id             String          @id @default(cuid())
  marca          String
  modelo         String
  patente        String          @unique
  anio           Int
  color          String?
  kilometraje    Int             @default(0)
  precioMensual  Float           @default(0)
  cilindrada     Int?
  tipo           String? // naked | touring | sport | scooter | custom
  descripcion    String?
  imagen         String?
  estado         String          @default("disponible") // disponible | alquilada | mantenimiento | baja
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  contratos      Contrato[]
  mantenimientos Mantenimiento[]
  gastos         Gasto[]
  facturasCompra FacturaCompra[]
}

model Contrato {
  id                String   @id @default(cuid())
  clienteId         String
  motoId            String
  fechaInicio       DateTime
  fechaFin          DateTime
  frecuenciaPago    String   @default("mensual") // semanal | quincenal | mensual
  montoPeriodo      Float // Monto por período según frecuencia
  montoTotal        Float // Monto total del contrato
  deposito          Float    @default(0)
  descuentoAplicado Float    @default(0)
  notas             String?
  renovacionAuto    Boolean  @default(false)
  estado            String   @default("pendiente") // pendiente | activo | finalizado | cancelado
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  cliente           Cliente  @relation(fields: [clienteId], references: [id])
  moto              Moto     @relation(fields: [motoId], references: [id])
  pagos             Pago[]
  alertas           Alerta[]
}

model Pago {
  id            String    @id @default(cuid())
  contratoId    String
  monto         Float
  metodo        String    @default("pendiente") // transferencia | tarjeta | mercadopago | efectivo | pendiente
  estado        String    @default("pendiente") // pendiente | aprobado | rechazado | reembolsado | cancelado
  referencia    String?
  mpPaymentId   String? // ID de transacción de MercadoPago
  comprobante   String? // URL o texto del comprobante
  notas         String? // Notas adicionales del pago
  pagadoAt      DateTime?
  vencimientoAt DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  contrato      Contrato  @relation(fields: [contratoId], references: [id])
  factura       Factura?
  alertas       Alerta[]
}

model Factura {
  id             String    @id @default(cuid())
  numero         String // Autoincremental 00000001, 00000002, etc.
  tipo           String // A, B, C
  puntoVenta     Int       @default(1)
  montoNeto      Float // Subtotal sin IVA (si tipo A)
  montoIva       Float // IVA 21% (si tipo A)
  montoTotal     Float // Total final
  cae            String? // Código de Autorización Electrónico de AFIP
  caeVencimiento String? // Fecha de vencimiento del CAE
  razonSocial    String? // Razón social del cliente (opcional)
  cuit           String? // CUIT del cliente (opcional)
  emitida        Boolean   @default(false) // false = pendiente AFIP, true = emitida con CAE
  emailEnviado   Boolean   @default(false) // true si se envió por email
  emailEnviadoAt DateTime? // Fecha/hora del último envío por email
  pagoId         String    @unique
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  pago           Pago      @relation(fields: [pagoId], references: [id])
}

model Alerta {
  id              String    @id @default(cuid())
  tipo            String
  mensaje         String
  metadata        Json?
  contratoId      String?
  pagoId          String?
  leida           Boolean   @default(false)
  dniVerificacion Json?
  createdAt       DateTime  @default(now())
  contrato        Contrato? @relation(fields: [contratoId], references: [id])
  pago            Pago?     @relation(fields: [pagoId], references: [id])
}

// ─── Mantenimiento ──────────────────────────────────────────────────────────

model Mantenimiento {
  id                  String              @id @default(cuid())
  visibleId           String              @unique @default(cuid())
  motoId              String
  moto                Moto                @relation(fields: [motoId], references: [id])
  tipo                TipoMantenimiento
  estado              EstadoMantenimiento @default(PENDIENTE)
  descripcion         String
  diagnostico         String?
  solucion            String?
  costoRepuestos      Float               @default(0)
  costoManoObra       Float               @default(0)
  costoTotal          Float               @default(0)
  proveedorId         String?
  proveedor           Proveedor?          @relation(fields: [proveedorId], references: [id])
  kmAlMomento         Int?
  fechaProgramada     DateTime?
  fechaInicio         DateTime?
  fechaFin            DateTime?
  proximoServiceKm    Int?
  proximoServiceFecha DateTime?
  notas               String?
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  repuestos           RepuestoUsado[]
  gastos              Gasto[]
}

model Proveedor {
  id             String          @id @default(cuid())
  visibleId      String          @unique @default(cuid())
  nombre         String
  cuit           String?
  condicionIva   CondicionIva?
  contacto       String?
  telefono       String?
  email          String?
  direccion      String?
  rubro          String?
  notas          String?
  activo         Boolean         @default(true)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  mantenimientos Mantenimiento[]
  repuestos      Repuesto[]
  gastos         Gasto[]
  facturasCompra FacturaCompra[]
}

model Repuesto {
  id           String          @id @default(cuid())
  visibleId    String          @unique @default(cuid())
  nombre       String
  codigo       String?
  categoria    String?
  precioCompra Float           @default(0)
  precioVenta  Float           @default(0)
  stock        Int             @default(0)
  stockMinimo  Int             @default(2)
  proveedorId  String?
  proveedor    Proveedor?      @relation(fields: [proveedorId], references: [id])
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  usos         RepuestoUsado[]
}

model RepuestoUsado {
  id              String        @id @default(cuid())
  mantenimientoId String
  mantenimiento   Mantenimiento @relation(fields: [mantenimientoId], references: [id], onDelete: Cascade)
  repuestoId      String
  repuesto        Repuesto      @relation(fields: [repuestoId], references: [id])
  cantidad        Int           @default(1)
  precioUnitario  Float
  subtotal        Float
  createdAt       DateTime      @default(now())
}

enum TipoMantenimiento {
  SERVICE_PREVENTIVO
  REPARACION
  CAMBIO_ACEITE
  CAMBIO_NEUMATICOS
  FRENOS
  ELECTRICA
  CHAPA_PINTURA
  OTRO
}

enum EstadoMantenimiento {
  PENDIENTE
  PROGRAMADO
  EN_PROCESO
  ESPERANDO_REPUESTO
  COMPLETADO
  CANCELADO
}

// ─── Finanzas ───────────────────────────────────────────────────────────────

model Gasto {
  id              String         @id @default(cuid())
  visibleId       String         @unique @default(cuid())
  concepto        String
  descripcion     String?
  monto           Float
  categoria       CategoriaGasto
  subcategoria    String?
  motoId          String?
  moto            Moto?          @relation(fields: [motoId], references: [id])
  proveedorId     String?
  proveedor       Proveedor?     @relation(fields: [proveedorId], references: [id])
  mantenimientoId String?
  mantenimiento   Mantenimiento? @relation(fields: [mantenimientoId], references: [id])
  metodoPago      String?
  comprobante     String?
  fecha           DateTime       @default(now())
  notas           String?
  facturaCompra   FacturaCompra?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
}

model PresupuestoMensual {
  id                 String         @id @default(cuid())
  mes                Int
  anio               Int
  categoria          CategoriaGasto
  montoPresupuestado Float
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt

  @@unique([mes, anio, categoria])
}

enum CategoriaGasto {
  MANTENIMIENTO
  COMBUSTIBLE
  SEGURO
  PATENTE
  REPUESTOS
  ALQUILER_LOCAL
  SERVICIOS
  SUELDOS
  MARKETING
  IMPUESTOS
  GRUA
  ADMINISTRATIVO
  OTRO
}

// ─── Pricing ────────────────────────────────────────────────────────────────

model PricingConfig {
  id                String   @id @unique @default("default")
  precioBaseMensual Float
  descuentoSemanal  Float
  descuentoMeses3   Float
  descuentoMeses6   Float
  descuentoMeses9   Float
  descuentoMeses12  Float
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model ConfiguracionEmpresa {
  id                   String        @id @unique @default("default")
  razonSocial          String        @default("MotoLibre S.A.S")
  cuit                 String?
  condicionIva         CondicionIva  @default(RESPONSABLE_INSCRIPTO)
  domicilioComercial   String?
  domicilioFiscal      String?
  inicioActividades    DateTime?
  telefono             String?
  email                String?
  actividadPrincipal   String?
  puntoVentaAfip       String?
  certificadoAfipPath  String?
  createdAt            DateTime      @default(now())
  updatedAt            DateTime      @updatedAt
}

enum CondicionIva {
  RESPONSABLE_INSCRIPTO
  MONOTRIBUTISTA
  EXENTO
  NO_RESPONSABLE
  CONSUMIDOR_FINAL
}

// ─── Contabilidad ───────────────────────────────────────────────────────────

model FacturaCompra {
  id        String @id @default(cuid())
  visibleId String @unique @default(cuid())

  // Proveedor
  proveedorId String?
  proveedor   Proveedor? @relation(fields: [proveedorId], references: [id])
  razonSocial String
  cuit        String?

  // Invoice
  tipo        TipoFacturaCompra
  numero      String
  puntoVenta  String?
  fecha       DateTime
  vencimiento DateTime?

  // Impuestos argentinos
  subtotal       Float
  iva21          Float @default(0)
  iva105         Float @default(0)
  iva27          Float @default(0)
  percepcionIVA  Float @default(0)
  percepcionIIBB Float @default(0)
  impInterno     Float @default(0)
  noGravado      Float @default(0)
  exento         Float @default(0)
  total          Float

  // Categorización
  categoria    CategoriaGasto
  subcategoria String?
  centroGasto  String?
  motoId       String?
  moto         Moto?          @relation(fields: [motoId], references: [id])

  // Estado y Workflow
  estado             EstadoFacturaCompra @default(BORRADOR)
  estadoAnterior     EstadoFacturaCompra?
  estadoMotivo       String?
  montoAbonado       Float               @default(0)
  aprobadoPor        String?
  aprobadoFecha      DateTime?
  aprobador          User?               @relation("FacturaAprobador", fields: [aprobadoPor], references: [id])
  creadoPor          String?
  creador            User?               @relation("FacturaCreador", fields: [creadoPor], references: [id])

  // Archivo + OCR
  archivoUrl    String?
  archivoNombre String?
  ocrRawData    Json?
  ocrConfianza  Float?
  ocrRevisado   Boolean @default(false)

  // CAE (Código Autorización Electrónico)
  cae                String?
  caeVencimiento     DateTime?
  caeVerificado      Boolean?
  caeVerificadoFecha DateTime?

  // Control de Duplicidad
  hashUnico String? @unique

  // Relaciones
  gastoId   String?          @unique
  gasto     Gasto?           @relation(fields: [gastoId], references: [id])
  asientoId String?          @unique
  asiento   AsientoContable? @relation(fields: [asientoId], references: [id])
  auditLogs AuditLog[]

  notas     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([fecha])
  @@index([proveedorId])
  @@index([estado])
  @@index([vencimiento])
  @@index([hashUnico])
  @@index([cuit, tipo, puntoVenta, numero])
}

model CuentaContable {
  id          String         @id @default(cuid())
  codigo      String         @unique
  nombre      String
  tipo        TipoCuenta
  padre       String?
  nivel       Int            @default(1)
  imputable   Boolean        @default(true)
  activa      Boolean        @default(true)
  descripcion String?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  lineas      LineaAsiento[]

  @@index([tipo])
  @@index([codigo])
}

model AsientoContable {
  id              String         @id @default(cuid())
  visibleId       String         @unique @default(cuid())
  numero          Int            @unique @default(autoincrement())
  fecha           DateTime
  tipo            TipoAsiento
  descripcion     String
  totalDebe       Float
  totalHaber      Float
  facturaCompraId String?        @unique
  facturaCompra   FacturaCompra?
  cerrado         Boolean        @default(false)
  creadoPor       String?
  notas           String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  lineas          LineaAsiento[]

  @@index([fecha])
  @@index([tipo])
}

model LineaAsiento {
  id          String          @id @default(cuid())
  asientoId   String
  asiento     AsientoContable @relation(fields: [asientoId], references: [id], onDelete: Cascade)
  orden       Int
  cuentaId    String
  cuenta      CuentaContable  @relation(fields: [cuentaId], references: [id])
  debe        Float           @default(0)
  haber       Float           @default(0)
  descripcion String?
  createdAt   DateTime        @default(now())

  @@index([asientoId])
}

enum TipoFacturaCompra {
  A
  B
  C
  TICKET
  RECIBO
}

enum EstadoFacturaCompra {
  BORRADOR
  PENDIENTE
  PENDIENTE_REVISION
  APROBADA
  RECHAZADA
  PAGADA
  PAGADA_PARCIAL
  VENCIDA
  ANULADA
}

enum TipoCuenta {
  ACTIVO
  PASIVO
  PATRIMONIO
  INGRESO
  EGRESO
}

enum TipoAsiento {
  APERTURA
  COMPRA
  VENTA
  PAGO
  COBRO
  AJUSTE
  CIERRE
}

// ─── RRHH ────────────────────────────────────────────────────────────────────

model Empleado {
  id        String @id @default(cuid())
  visibleId String @unique @default(cuid())

  // Datos personales
  nombre             String
  apellido           String
  dni                String    @unique
  cuil               String?   @unique
  fechaNacimiento    DateTime?
  sexo               String? // M, F, X
  estadoCivil        String? // SOLTERO, CASADO, DIVORCIADO, VIUDO, UNION_CONVIVENCIAL
  nacionalidad       String?   @default("Argentina")
  direccion          String?
  ciudad             String?
  provincia          String?
  codigoPostal       String?
  telefono           String?
  email              String?
  contactoEmergencia String?
  telefonoEmergencia String?

  // Datos laborales
  fechaIngreso   DateTime
  fechaEgreso    DateTime?
  estado         EstadoEmpleado @default(ACTIVO)
  cargo          String
  departamento   String? // OPERACIONES, ADMINISTRACION, COMERCIAL, TALLER
  tipoContrato   TipoContrato   @default(TIEMPO_INDETERMINADO)
  jornadaLaboral String? // COMPLETA, PARCIAL
  horasSemanales Int?           @default(48)

  // Datos salariales
  salarioBasico Float
  categoriaCCT  String? // Categoría del convenio colectivo
  obraSocial    String?
  sindicato     String?
  nroAfiliado   String?
  cbu           String?
  banco         String?

  // Documentación
  altaAFIP      Boolean   @default(false)
  fechaAltaAFIP DateTime?
  artContratada String? // Nombre de la ART
  nroART        String?

  imagen String?
  notas  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  recibos    ReciboSueldo[]
  ausencias  Ausencia[]
  documentos DocumentoEmpleado[]

  @@index([estado])
  @@index([dni])
}

model ReciboSueldo {
  id         String   @id @default(cuid())
  visibleId  String   @unique @default(cuid())
  empleadoId String
  empleado   Empleado @relation(fields: [empleadoId], references: [id])

  // Período
  mes  Int // 1-12
  anio Int
  tipo TipoRecibo @default(MENSUAL) // MENSUAL, SAC_1, SAC_2, FINAL, VACACIONES

  // Haberes (conceptos que suman)
  salarioBasico Float
  presentismo   Float @default(0)
  antiguedad    Float @default(0)
  horasExtra50  Float @default(0)
  horasExtra100 Float @default(0)
  adicionales   Float @default(0)
  totalHaberes  Float

  // Deducciones (conceptos que restan)
  jubilacion        Float @default(0) // 11%
  obraSocial        Float @default(0) // 3%
  sindicato         Float @default(0) // 2-3%
  ley19032          Float @default(0) // 3% PAMI/INSSJP
  impuestoGanancias Float @default(0)
  otrasDeduccciones Float @default(0)
  totalDeducciones  Float

  // Aportes patronales (no descuento al empleado, costo empresa)
  aporteJubilacion       Float @default(0) // 16%
  aporteObraSocial       Float @default(0) // 6%
  aportePAMI             Float @default(0) // 1.5%
  aporteART              Float @default(0)
  seguroVida             Float @default(0)
  totalAportesPatronales Float

  // Neto
  netoAPagar Float

  // Estado
  estado    EstadoRecibo @default(BORRADOR)
  fechaPago DateTime?

  pdfUrl String?
  notas  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([empleadoId])
  @@index([mes, anio])
  @@index([estado])
}

model Ausencia {
  id          String       @id @default(cuid())
  empleadoId  String
  empleado    Empleado     @relation(fields: [empleadoId], references: [id])
  tipo        TipoAusencia
  fechaInicio DateTime
  fechaFin    DateTime
  dias        Int
  justificada Boolean      @default(false)
  certificado String?
  notas       String?
  estado      String       @default("PENDIENTE") // PENDIENTE, APROBADA, RECHAZADA
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@index([empleadoId])
  @@index([fechaInicio, fechaFin])
}

model DocumentoEmpleado {
  id         String   @id @default(cuid())
  empleadoId String
  empleado   Empleado @relation(fields: [empleadoId], references: [id], onDelete: Cascade)
  tipo       String // DNI, CUIL, CONTRATO, ALTA_AFIP, ART, CV, CERTIFICADO, OTRO
  nombre     String
  url        String?
  notas      String?
  createdAt  DateTime @default(now())

  @@index([empleadoId])
}

enum EstadoEmpleado {
  ACTIVO
  LICENCIA
  SUSPENDIDO
  BAJA
}

enum TipoContrato {
  TIEMPO_INDETERMINADO
  PLAZO_FIJO
  EVENTUAL
  TEMPORADA
  PASANTIA
}

enum TipoRecibo {
  MENSUAL
  SAC_1
  SAC_2
  FINAL
  VACACIONES
}

enum TipoAusencia {
  VACACIONES
  ENFERMEDAD
  ACCIDENTE_LABORAL
  LICENCIA_MATERNIDAD
  LICENCIA_PATERNIDAD
  ESTUDIO
  MATRIMONIO
  FALLECIMIENTO_FAMILIAR
  MUDANZA
  DONACION_SANGRE
  INJUSTIFICADA
  OTRO
}

enum EstadoRecibo {
  BORRADOR
  CONFIRMADO
  PAGADO
  ANULADO
}

// ─── Auditoría y Controles Internos ─────────────────────────────────────────

model AuditLog {
  id             String   @id @default(cuid())
  entidad        String   // "FacturaCompra", "AsientoContable", "Empleado", etc
  entidadId      String   // ID del registro
  accion         String   // "CREAR", "EDITAR", "ELIMINAR", "CAMBIO_ESTADO", "APROBAR", "RECHAZAR"
  campo          String?  // qué campo cambió
  valorAnterior  String?  // valor viejo (JSON)
  valorNuevo     String?  // valor nuevo (JSON)
  usuarioId      String
  usuario        User     @relation(fields: [usuarioId], references: [id])
  ip             String?
  userAgent      String?
  facturaCompra  FacturaCompra? @relation(fields: [facturaCompraId], references: [id])
  facturaCompraId String?
  createdAt      DateTime @default(now())

  @@index([entidad, entidadId])
  @@index([usuarioId])
  @@index([createdAt])
}

model PeriodoContable {
  id          String    @id @default(cuid())
  mes         Int       // 1-12
  anio        Int
  cerrado     Boolean   @default(false)
  cerradoPor  String?
  cerrador    User?     @relation(fields: [cerradoPor], references: [id])
  fechaCierre DateTime?
  motivo      String?   // Por qué se cerró
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([mes, anio])
  @@index([cerrado])
}

model DiagnosticoRun {
  id           String   @id @default(cuid())
  fecha        DateTime @default(now())
  duracion     Int      // segundos que tardó
  totalChecks  Int
  passed       Int
  warnings     Int
  errors       Int
  resultados   Json     // array con todos los checks
  ejecutadoPor String
  ejecutador   User     @relation(fields: [ejecutadoPor], references: [id])
  createdAt    DateTime @default(now())

  @@index([fecha])
  @@index([ejecutadoPor])
}
