generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ─── Auth ────────────────────────────────────────────────────────────────────

model User {
  id                      String             @id @default(cuid())
  email                   String             @unique
  name                    String
  image                   String?
  provider                String             // "credentials" | "google" | "apple" | "facebook"
  password                String?
  phone                   String?
  phoneVerifiedAt         DateTime?
  role                    Role               @default(CLIENTE)
  totpSecret              String?
  totpEnabled             Boolean            @default(false)
  createdAt               DateTime           @default(now())
  updatedAt               DateTime           @updatedAt
  cliente                 Cliente?
  facturasAprobadas       FacturaCompra[]    @relation("FacturaAprobador")
  facturasCreadas         FacturaCompra[]    @relation("FacturaCreador")
  auditLogs               AuditLog[]
  periodosCerrados        PeriodoContable[]
  diagnosticosEjecutados  DiagnosticoRun[]
  historialEstadosMotos   HistorialEstadoMoto[]
  notasCreditoCreadas     NotaCredito[]
  recepcionesMercaderia   RecepcionMercaderiaEmbarque[]
  businessEvents          BusinessEvent[]
  profiles                UserProfile[]
  conciliaciones          Conciliacion[]
}

enum Role {
  ADMIN
  OPERADOR
  CLIENTE
  CONTADOR
  RRHH_MANAGER
  COMERCIAL
  VIEWER
}

// ─── Negocio ─────────────────────────────────────────────────────────────────

model Cliente {
  id                  String     @id @default(cuid())
  userId              String     @unique
  nombre              String?
  email               String     @unique
  telefono            String?
  dni                 String?
  dniVerificado       Boolean    @default(false)
  licencia            String?
  licenciaVencimiento DateTime?
  licenciaVerificada  Boolean    @default(false)
  direccion           String?
  ciudad              String?
  provincia           String?
  codigoPostal        String?
  fechaNacimiento     DateTime?
  notas               String?
  estado              EstadoCliente @default(PENDIENTE)
  preRegistro         Json?
  aprobadoPor         String?
  aprobadoAt          DateTime?

  // ─── Puntaje de rider (nuevo módulo mantenimientos) ──────────────────────
  puntajePromedio        Decimal   @default(100) @db.Decimal(5,2) // Promedio histórico
  totalServices          Int       @default(0)
  servicesAsistidos      Int       @default(0)
  servicesNoAsistidos    Int       @default(0)

  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @default(now()) @updatedAt
  user                User       @relation(fields: [userId], references: [id])
  contratos           Contrato[]
  notasCredito        NotaCredito[]
  citasMantenimiento  CitaMantenimiento[]
  ordenesTrabajoRider OrdenTrabajo[] @relation("OrdenTrabajoRider")
  puntajes            PuntajeRider[]

  // ─── Relaciones nuevas pricing motor ──────────────────────────
  gruposCliente       MiembroGrupoCliente[]
}

enum EstadoCliente {
  PENDIENTE
  APROBADO
  RECHAZADO
}

model Moto {
  id             String          @id @default(cuid())
  marca          String
  modelo         String
  patente        String          @unique
  anio           Int
  color          String?
  kilometraje    Int             @default(0)
  precioMensual  Decimal         @default(0) @db.Decimal(12,2)
  cilindrada     Int?
  tipo           TipoMoto?
  descripcion    String?
  imagen         String?
  estado         EstadoMoto      @default(DISPONIBLE)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  contratos      Contrato[]
  gastos         Gasto[]
  facturasCompra FacturaCompra[]

  // ─── Identificación vehicular ───────────────────────────────────────────
  vin               String?   // VIN 17 caracteres
  numeroMotor       String?
  numeroCuadro      String?
  anioFabricacion   Int?
  paisOrigen        String?   // CHINA, INDIA, BRASIL, JAPON, etc

  // ─── Datos registrales DNRPA ────────────────────────────────────────────
  dominio           String?   @unique // Patente formato AA000AA
  fechaPatentamiento DateTime?
  registroSeccional String?
  titularRegistral  String?
  cedulaVerde       String?
  cedulaAzul        String?

  // ─── Financiero / Amortización ──────────────────────────────────────────
  valorCompra       Decimal?  @db.Decimal(12,2) // Costo adquisición (CIF si importada)
  fechaCompra       DateTime?
  valorResidual     Decimal?  @db.Decimal(12,2) // Valor residual estimado
  vidaUtilAnios     Int?      @default(5) // AFIP: 5 años para vehículos
  metodoAmortizacion MetodoAmortizacion? @default(LINEAL)

  // ─── Importación ────────────────────────────────────────────────────────
  esImportada       Boolean   @default(true)
  numeroDespachImport String?
  fechaImportacion  DateTime?
  valorFOB          Decimal?  @db.Decimal(12,2)
  valorCIF          Decimal?  @db.Decimal(12,2)
  derechosImportacion Decimal? @db.Decimal(12,2)

  // ─── Estado legal ───────────────────────────────────────────────────────
  estadoLegal       EstadoLegalMoto? @default(REGULAR)

  // === PATENTAMIENTO ===
  estadoPatentamiento    EstadoPatentamiento? @default(SIN_PATENTAR)
  fechaInicioTramitePatente DateTime?
  notasPatentamiento     String?

  // === SEGURO ===
  estadoSeguro           EstadoSeguro? @default(SIN_SEGURO)
  aseguradora            String?
  numeroPoliza           String?   @unique
  tipoCobertura          TipoCobertura?
  fechaInicioSeguro      DateTime?
  fechaVencimientoSeguro DateTime?
  notasSeguro            String?

  // ─── Mantenimientos (nuevo módulo) ──────────────────────────────────────
  fechaInicioOperaciones DateTime? // Fecha en que la moto empezó a operar (define ciclo mensual)
  kmActual               Int       @default(0) // Última lectura de km (actualizado por IoT)
  kmUltimoService        Int       @default(0) // Km en el último service completado
  fechaUltimoService     DateTime? // Fecha del último service completado
  proximoServiceFecha    DateTime? // Fecha calculada del próximo service
  proximoServiceTipo     TipoService? // Tipo de service que le toca según km

  // ─── Relaciones nuevas ──────────────────────────────────────────────────
  amortizaciones     Amortizacion[]
  documentos         DocumentoMoto[]
  historialEstados   HistorialEstadoMoto[]
  bajaMoto           BajaMoto?
  citasMantenimiento CitaMantenimiento[]
  ordenesTrabajoMoto OrdenTrabajo[]
  lecturasKm         LecturaKm[]
}

enum EstadoMoto {
  DISPONIBLE
  ALQUILADA
  MANTENIMIENTO
  BAJA
  TRANSFERIDA
}

enum TipoMoto {
  NAKED
  TOURING
  SPORT
  SCOOTER
  CUSTOM
}

enum EstadoLegalMoto {
  REGULAR
  DENUNCIA_ROBO
  SINIESTRO_TOTAL
  BAJA_DEFINITIVA
  EN_PROCESO_PATENTAMIENTO
  PRENDA
}

enum EstadoPatentamiento {
  SIN_PATENTAR
  EN_TRAMITE
  PATENTADA
}

enum EstadoSeguro {
  SIN_SEGURO
  EN_TRAMITE
  ASEGURADA
}

enum TipoCobertura {
  RESPONSABILIDAD_CIVIL
  TERCEROS_COMPLETO
  TODO_RIESGO
}

enum MetodoAmortizacion {
  LINEAL
}

model Contrato {
  id                String   @id @default(cuid())
  clienteId         String
  motoId            String
  fechaInicio       DateTime
  fechaFin          DateTime
  frecuenciaPago    FrecuenciaPago @default(MENSUAL)
  montoPeriodo      Decimal  @db.Decimal(12,2) // Monto por período según frecuencia
  montoTotal        Decimal  @db.Decimal(12,2) // Monto total del contrato
  deposito          Decimal  @default(0) @db.Decimal(12,2)
  descuentoAplicado Decimal  @default(0) @db.Decimal(12,2)
  notas             String?
  renovacionAuto    Boolean  @default(false)
  estado            EstadoContrato @default(PENDIENTE)

  // ─── Opción a Compra ────────────────────────────────────────────────────
  esOpcionCompra    Boolean  @default(false)
  mesesParaCompra   Int?     @default(24)
  valorCompraFinal  Decimal? @db.Decimal(12,2) // Precio al ejercer opción
  opcionEjercida    Boolean  @default(false)
  fechaEjercicio    DateTime?

  // === Pricing Engine V2 ===
  planAlquilerId    String?
  planAlquiler      PlanAlquiler? @relation(fields: [planAlquilerId], references: [id])
  cuotasPagadas     Int           @default(0)
  progresoOwnership Decimal       @default(0) @db.Decimal(5,2)

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  cliente           Cliente  @relation(fields: [clienteId], references: [id])
  moto              Moto     @relation(fields: [motoId], references: [id])
  pagos             Pago[]
  alertas           Alerta[]

  @@index([clienteId])
  @@index([motoId])
  @@index([estado])
}

model Pago {
  id            String    @id @default(cuid())
  contratoId    String
  monto         Decimal   @db.Decimal(12,2)
  metodo        MetodoPago  @default(PENDIENTE)
  estado        EstadoPago  @default(PENDIENTE)
  referencia    String?
  mpPaymentId   String? @unique // ID de transacción de MercadoPago
  comprobante   String? // URL o texto del comprobante
  notas         String? // Notas adicionales del pago
  pagadoAt      DateTime?
  vencimientoAt DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  contrato      Contrato  @relation(fields: [contratoId], references: [id])
  factura       Factura?
  alertas       Alerta[]

  @@index([contratoId])
  @@index([estado])
  @@index([vencimientoAt])
}

model Factura {
  id             String    @id @default(cuid())
  numero         String    @unique // Autoincremental 00000001, 00000002, etc.
  tipo           TipoFactura @default(B)
  puntoVenta     Int       @default(1)
  montoNeto      Decimal  @db.Decimal(12,2) // Subtotal sin IVA (si tipo A)
  montoIva       Decimal  @db.Decimal(12,2) // IVA 21% (si tipo A)
  montoTotal     Decimal  @db.Decimal(12,2) // Total final
  cae            String? // Código de Autorización Electrónico de AFIP
  caeVencimiento DateTime? // Fecha de vencimiento del CAE
  razonSocial    String? // Razón social del cliente (opcional)
  cuit           String? // CUIT del cliente (opcional)
  emitida        Boolean   @default(false) // false = pendiente AFIP, true = emitida con CAE
  emailEnviado   Boolean   @default(false) // true si se envió por email
  emailEnviadoAt DateTime? // Fecha/hora del último envío por email
  pagoId         String    @unique
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  pago           Pago      @relation(fields: [pagoId], references: [id])

  @@index([createdAt])
}

enum FrecuenciaPago {
  SEMANAL
  QUINCENAL
  MENSUAL
}

enum EstadoContrato {
  PENDIENTE
  ACTIVO
  FINALIZADO
  CANCELADO
  FINALIZADO_COMPRA
  VENCIDO
}

enum MetodoPago {
  EFECTIVO
  TRANSFERENCIA
  TARJETA
  MERCADOPAGO
  PENDIENTE
}

enum EstadoPago {
  PENDIENTE
  APROBADO
  RECHAZADO
  REEMBOLSADO
  CANCELADO
  VENCIDO
}

model Alerta {
  id              String    @id @default(cuid())
  tipo            TipoAlerta
  mensaje         String
  metadata        Json?
  contratoId      String?
  pagoId          String?
  leida           Boolean   @default(false)
  dniVerificacion Json?
  createdAt       DateTime  @default(now())
  contrato        Contrato? @relation(fields: [contratoId], references: [id])
  pago            Pago?     @relation(fields: [pagoId], references: [id])
}

// ─── Proveedores y Repuestos (mantienen compatibilidad) ────────────────────

model Proveedor {
  id             String          @id @default(cuid())
  visibleId      String          @unique @default(cuid())
  nombre         String
  codigoCorto    String?         // Código corto único para generación de SKU (ej: "CH01", "CH02")
  cuit           String?
  condicionIva   CondicionIva?
  contacto       String?
  telefono       String?
  email          String?
  direccion      String?
  rubro          String?
  notas          String?
  activo         Boolean         @default(true)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  repuestos      Repuesto[]
  gastos         Gasto[]
  facturasCompra FacturaCompra[]
  ordenesCompra  OrdenCompra[]
  embarques      EmbarqueImportacion[]
}

model Repuesto {
  id           String          @id @default(cuid())
  visibleId    String          @unique @default(cuid())
  nombre       String
  codigo       String?
  categoria    String?
  precioCompra Decimal         @default(0) @db.Decimal(12,2)
  precioVenta  Decimal         @default(0) @db.Decimal(12,2)
  stock        Int             @default(0)
  stockMinimo  Int             @default(2)
  proveedorId  String?
  proveedor    Proveedor?      @relation(fields: [proveedorId], references: [id])
  unidad       String?
  vidaUtilKm   Int?

  // ─── Campos nuevos V2 ─────────────────────────────────────────
  descripcion      String?   // Descripción detallada / notas
  marca            String?   // Marca del repuesto
  modelo           String?   // Modelo compatible (ej: "Honda Wave 110")
  codigoFabricante String?   // Código original del fabricante (para match con packing lists)
  imagenUrl        String?   // URL de foto del repuesto en R2
  imagenKey        String?   // Key en R2 para poder eliminar
  ubicacion        String?   // Ubicación en depósito: "E2-F3-P1" (Estante-Fila-Posición)
  codigoBarras     String?   // Código de barras del fabricante
  unidadCompra     String?   // "caja", "bolsa", "unidad"
  factorConversion Decimal?  @default(1) @db.Decimal(10,4) // Cuántas unidades hay en 1 unidad de compra (ej: caja de 12 = 12)
  peso             Decimal?  @db.Decimal(10,2) // Peso en gramos (para envíos/logística)
  activo           Boolean   @default(true) // Para dar de baja sin eliminar

  // ─── Campos nuevos de costeo ──────────────────────────────────
  ncmCodigo          String?   // Nomenclatura Común del Mercosur (ej: "8714.10.00")
  pesoUnitarioKg     Decimal?  @db.Decimal(10,4) // Peso por unidad en kg (para prorrateo de flete)
  volumenUnitarioCbm Decimal?  @db.Decimal(10,6) // Volumen por unidad en CBM (para prorrateo)
  esOEM              Boolean   @default(false) // Original vs genérico
  costoPromedioArs   Decimal   @default(0) @db.Decimal(12,2) // Costo promedio ponderado actual en ARS
  costoPromedioUsd   Decimal   @default(0) @db.Decimal(12,2) // Costo promedio ponderado actual en USD
  ultimoCostoUpdate  DateTime? // Última vez que se recalculó el costo promedio
  margenObjetivo     Decimal?  @db.Decimal(5,2) // Margen objetivo para esta pieza (override de categoría)
  margenMinimo       Decimal?  @db.Decimal(5,2) // Margen mínimo (override de categoría)

  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  tareasPlan   TareaPlan[]
  repuestosOT  RepuestoOrdenTrabajo[]
  repuestosTareaPlan RepuestoTareaPlan[]

  // ─── Relaciones nuevas V2 ────────────────────────────────────
  movimientos      MovimientoStock[]
  itemsOrdenCompra ItemOrdenCompra[]
  itemsRecepcion   ItemRecepcion[]

  // ─── Relaciones nuevas costeo ─────────────────────────────────
  historialCostos    HistorialCostoRepuesto[]
  asignacionesCosto  AsignacionCostoImportacion[]
  itemsEmbarque      ItemEmbarque[]

  // ─── Relaciones nuevas pricing motor ──────────────────────────
  itemsListaPrecio   ItemListaPrecio[]
  historialPrecios   HistorialPrecioRepuesto[]

  // ─── Relaciones nuevas recepción mercadería ───────────────────
  recepcionesItems   RecepcionItemEmbarque[]

  @@index([proveedorId])
  @@index([categoria])
}

// ─── Configuración de categorías de repuestos ───────────────────────────────

model CategoriaRepuestoConfig {
  id             String   @id @default(cuid())
  categoria      String   @unique
  nombre         String
  margenObjetivo Decimal @db.Decimal(5,2)
  margenMinimo   Decimal @db.Decimal(5,2)
  markupDefault  Decimal @db.Decimal(5,2)
  arancelImpo    Decimal @db.Decimal(5,2)
  ncmDefault     String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

// ─── Finanzas ───────────────────────────────────────────────────────────────

model Gasto {
  id              String         @id @default(cuid())
  visibleId       String         @unique @default(cuid())
  concepto        String
  descripcion     String?
  monto           Decimal        @db.Decimal(12,2)
  categoria       CategoriaGasto
  subcategoria    String?
  motoId          String?
  moto            Moto?          @relation(fields: [motoId], references: [id])
  proveedorId     String?
  proveedor       Proveedor?     @relation(fields: [proveedorId], references: [id])
  metodoPago      String?
  comprobante     String?
  fecha           DateTime       @default(now())
  notas           String?
  facturaCompra   FacturaCompra?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@index([motoId])
  @@index([proveedorId])
  @@index([fecha])
  @@index([categoria])
}

model PresupuestoMensual {
  id                 String         @id @default(cuid())
  mes                Int
  anio               Int
  categoria          CategoriaGasto
  montoPresupuestado Decimal    @db.Decimal(12,2)
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt

  @@unique([mes, anio, categoria])
}

enum CategoriaGasto {
  MANTENIMIENTO
  COMBUSTIBLE
  SEGURO
  PATENTE
  REPUESTOS
  ALQUILER_LOCAL
  SERVICIOS
  SUELDOS
  MARKETING
  IMPUESTOS
  GRUA
  ADMINISTRATIVO
  OTRO
}

// ─── Pricing ────────────────────────────────────────────────────────────────

model PricingConfig {
  id                String   @id @unique @default("default")
  precioBaseMensual Decimal @db.Decimal(12,2)
  descuentoSemanal  Decimal @db.Decimal(5,2)
  descuentoMeses3   Decimal @db.Decimal(5,2)
  descuentoMeses6   Decimal @db.Decimal(5,2)
  descuentoMeses9   Decimal @db.Decimal(5,2)
  descuentoMeses12  Decimal @db.Decimal(5,2)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model ConfiguracionEmpresa {
  id                   String        @id @unique @default("default")
  razonSocial          String        @default("MotoLibre S.A.S")
  cuit                 String?
  condicionIva         CondicionIva  @default(RESPONSABLE_INSCRIPTO)
  domicilioComercial   String?
  domicilioFiscal      String?
  inicioActividades    DateTime?
  telefono             String?
  email                String?
  actividadPrincipal   String?
  puntoVentaAfip       String?
  certificadoAfipPath  String?
  createdAt            DateTime      @default(now())
  updatedAt            DateTime      @updatedAt
}

enum CondicionIva {
  RESPONSABLE_INSCRIPTO
  MONOTRIBUTISTA
  EXENTO
  NO_RESPONSABLE
  CONSUMIDOR_FINAL
}

// ─── Contabilidad ───────────────────────────────────────────────────────────

model FacturaCompra {
  id        String @id @default(cuid())
  visibleId String @unique @default(cuid())

  // Proveedor
  proveedorId String?
  proveedor   Proveedor? @relation(fields: [proveedorId], references: [id])
  razonSocial String
  cuit        String?

  // Invoice
  tipo        TipoFacturaCompra
  numero      String
  puntoVenta  String?
  fecha       DateTime
  vencimiento DateTime?

  // Impuestos argentinos
  subtotal       Decimal @db.Decimal(12,2)
  iva21          Decimal @default(0) @db.Decimal(12,2)
  iva105         Decimal @default(0) @db.Decimal(12,2)
  iva27          Decimal @default(0) @db.Decimal(12,2)
  percepcionIVA  Decimal @default(0) @db.Decimal(12,2)
  percepcionIIBB Decimal @default(0) @db.Decimal(12,2)
  impInterno     Decimal @default(0) @db.Decimal(12,2)
  noGravado      Decimal @default(0) @db.Decimal(12,2)
  exento         Decimal @default(0) @db.Decimal(12,2)
  total          Decimal @db.Decimal(12,2)

  // Categorización
  categoria    CategoriaGasto
  subcategoria String?
  centroGasto  String?
  motoId       String?
  moto         Moto?          @relation(fields: [motoId], references: [id])

  // Estado y Workflow
  estado             EstadoFacturaCompra @default(BORRADOR)
  estadoAnterior     EstadoFacturaCompra?
  estadoMotivo       String?
  montoAbonado       Decimal             @default(0) @db.Decimal(12,2)
  aprobadoPor        String?
  aprobadoFecha      DateTime?
  aprobador          User?               @relation("FacturaAprobador", fields: [aprobadoPor], references: [id])
  creadoPor          String?
  creador            User?               @relation("FacturaCreador", fields: [creadoPor], references: [id])

  // Archivo + OCR
  archivoUrl    String?
  archivoNombre String?
  ocrRawData    Json?
  ocrConfianza  Decimal? @db.Decimal(5,4)
  ocrRevisado   Boolean @default(false)

  // CAE (Código Autorización Electrónico)
  cae                String?
  caeVencimiento     DateTime?
  caeVerificado      Boolean?
  caeVerificadoFecha DateTime?

  // Control de Duplicidad
  hashUnico String? @unique

  // Relaciones
  gastoId   String?          @unique
  gasto     Gasto?           @relation(fields: [gastoId], references: [id])
  asientoId String?          @unique
  asiento   AsientoContable? @relation(fields: [asientoId], references: [id])
  auditLogs AuditLog[]

  notas     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([fecha])
  @@index([proveedorId])
  @@index([estado])
  @@index([vencimiento])
  @@index([hashUnico])
  @@index([cuit, tipo, puntoVenta, numero])
}

model CuentaContable {
  id          String         @id @default(cuid())
  codigo      String         @unique
  nombre      String
  tipo        TipoCuenta
  padre       String?
  nivel       Int            @default(1)
  imputable   Boolean        @default(true)
  activa      Boolean        @default(true)
  descripcion String?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  lineas          LineaAsiento[]
  cuentasBancarias CuentaBancaria[]

  @@index([tipo])
  @@index([codigo])
}

model AsientoContable {
  id              String         @id @default(cuid())
  visibleId       String         @unique @default(cuid())
  numero          Int            @unique @default(autoincrement())
  fecha           DateTime
  tipo            TipoAsiento
  descripcion     String
  totalDebe       Decimal  @db.Decimal(12,2)
  totalHaber      Decimal  @db.Decimal(12,2)
  facturaCompraId String?        @unique
  facturaCompra   FacturaCompra?
  cerrado         Boolean        @default(false)
  creadoPor       String?
  notas           String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  lineas          LineaAsiento[]

  @@index([fecha])
  @@index([tipo])
}

model LineaAsiento {
  id          String          @id @default(cuid())
  asientoId   String
  asiento     AsientoContable @relation(fields: [asientoId], references: [id], onDelete: Cascade)
  orden       Int
  cuentaId    String
  cuenta      CuentaContable  @relation(fields: [cuentaId], references: [id])
  debe        Decimal         @default(0) @db.Decimal(12,2)
  haber       Decimal         @default(0) @db.Decimal(12,2)
  descripcion String?
  createdAt   DateTime        @default(now())

  @@index([asientoId])
}

enum TipoFacturaCompra {
  A
  B
  C
  TICKET
  RECIBO
}

enum EstadoFacturaCompra {
  BORRADOR
  PENDIENTE
  PENDIENTE_REVISION
  APROBADA
  RECHAZADA
  PAGADA
  PAGADA_PARCIAL
  VENCIDA
  ANULADA
}

enum TipoCuenta {
  ACTIVO
  PASIVO
  PATRIMONIO
  INGRESO
  EGRESO
}

enum TipoAsiento {
  APERTURA
  COMPRA
  VENTA
  PAGO
  COBRO
  AJUSTE
  CIERRE
}

// ─── RRHH ────────────────────────────────────────────────────────────────────

model Empleado {
  id        String @id @default(cuid())
  visibleId String @unique @default(cuid())

  // Datos personales
  nombre             String
  apellido           String
  dni                String    @unique
  cuil               String?   @unique
  fechaNacimiento    DateTime?
  sexo               SexoEmpleado?
  estadoCivil        EstadoCivil?
  nacionalidad       String?   @default("Argentina")
  direccion          String?
  ciudad             String?
  provincia          String?
  codigoPostal       String?
  telefono           String?
  email              String?
  contactoEmergencia String?
  telefonoEmergencia String?

  // Datos laborales
  fechaIngreso   DateTime
  fechaEgreso    DateTime?
  estado         EstadoEmpleado @default(ACTIVO)
  cargo          String
  departamento   Departamento?
  tipoContrato   TipoContrato   @default(TIEMPO_INDETERMINADO)
  jornadaLaboral JornadaLaboral? @default(COMPLETA)
  horasSemanales Int?           @default(48)

  // Datos salariales
  salarioBasico Decimal  @db.Decimal(12,2)
  categoriaCCT  String? // Categoría del convenio colectivo
  obraSocial    String?
  sindicato     String?
  nroAfiliado   String?
  cbu           String?
  banco         String?

  // Documentación
  altaAFIP      Boolean   @default(false)
  fechaAltaAFIP DateTime?
  artContratada String? // Nombre de la ART
  nroART        String?

  imagen String?
  notas  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  recibos    ReciboSueldo[]
  ausencias  Ausencia[]
  documentos DocumentoEmpleado[]

  @@index([estado])
  @@index([dni])
}

model ReciboSueldo {
  id         String   @id @default(cuid())
  visibleId  String   @unique @default(cuid())
  empleadoId String
  empleado   Empleado @relation(fields: [empleadoId], references: [id])

  // Período
  mes  Int // 1-12
  anio Int
  tipo TipoRecibo @default(MENSUAL) // MENSUAL, SAC_1, SAC_2, FINAL, VACACIONES

  // Haberes (conceptos que suman)
  salarioBasico Decimal @db.Decimal(12,2)
  presentismo   Decimal @default(0) @db.Decimal(12,2)
  antiguedad    Decimal @default(0) @db.Decimal(12,2)
  horasExtra50  Decimal @default(0) @db.Decimal(12,2)
  horasExtra100 Decimal @default(0) @db.Decimal(12,2)
  adicionales   Decimal @default(0) @db.Decimal(12,2)
  totalHaberes  Decimal @db.Decimal(12,2)

  // Deducciones (conceptos que restan)
  jubilacion        Decimal @default(0) @db.Decimal(12,2) // 11%
  obraSocial        Decimal @default(0) @db.Decimal(12,2) // 3%
  sindicato         Decimal @default(0) @db.Decimal(12,2) // 2-3%
  ley19032          Decimal @default(0) @db.Decimal(12,2) // 3% PAMI/INSSJP
  impuestoGanancias Decimal @default(0) @db.Decimal(12,2)
  otrasDeduccciones Decimal @default(0) @db.Decimal(12,2)
  totalDeducciones  Decimal @db.Decimal(12,2)

  // Aportes patronales (no descuento al empleado, costo empresa)
  aporteJubilacion       Decimal @default(0) @db.Decimal(12,2) // 16%
  aporteObraSocial       Decimal @default(0) @db.Decimal(12,2) // 6%
  aportePAMI             Decimal @default(0) @db.Decimal(12,2) // 1.5%
  aporteART              Decimal @default(0) @db.Decimal(12,2)
  seguroVida             Decimal @default(0) @db.Decimal(12,2)
  totalAportesPatronales Decimal @db.Decimal(12,2)

  // Neto
  netoAPagar Decimal @db.Decimal(12,2)

  // Estado
  estado    EstadoRecibo @default(BORRADOR)
  fechaPago DateTime?

  pdfUrl String?
  notas  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([empleadoId])
  @@index([mes, anio])
  @@index([estado])
}

model Ausencia {
  id          String       @id @default(cuid())
  empleadoId  String
  empleado    Empleado     @relation(fields: [empleadoId], references: [id])
  tipo        TipoAusencia
  fechaInicio DateTime
  fechaFin    DateTime
  dias        Int
  justificada Boolean      @default(false)
  certificado String?
  notas       String?
  estado      EstadoAusencia @default(PENDIENTE)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@index([empleadoId])
  @@index([fechaInicio, fechaFin])
}

model DocumentoEmpleado {
  id         String   @id @default(cuid())
  empleadoId String
  empleado   Empleado @relation(fields: [empleadoId], references: [id], onDelete: Cascade)
  tipo       TipoDocumentoEmpleado
  nombre     String
  url        String?
  notas      String?
  createdAt  DateTime @default(now())

  @@index([empleadoId])
}

enum EstadoEmpleado {
  ACTIVO
  LICENCIA
  SUSPENDIDO
  BAJA
}

enum TipoContrato {
  TIEMPO_INDETERMINADO
  PLAZO_FIJO
  EVENTUAL
  TEMPORADA
  PASANTIA
}

enum TipoRecibo {
  MENSUAL
  SAC_1
  SAC_2
  FINAL
  VACACIONES
}

enum TipoAusencia {
  VACACIONES
  ENFERMEDAD
  ACCIDENTE_LABORAL
  LICENCIA_MATERNIDAD
  LICENCIA_PATERNIDAD
  ESTUDIO
  MATRIMONIO
  FALLECIMIENTO_FAMILIAR
  MUDANZA
  DONACION_SANGRE
  INJUSTIFICADA
  OTRO
}

enum EstadoRecibo {
  BORRADOR
  CONFIRMADO
  PAGADO
  ANULADO
}

enum SexoEmpleado {
  M
  F
  X
}

enum EstadoCivil {
  SOLTERO
  CASADO
  DIVORCIADO
  VIUDO
  UNION_CONVIVENCIAL
}

enum Departamento {
  OPERACIONES
  ADMINISTRACION
  COMERCIAL
  TALLER
}

enum JornadaLaboral {
  COMPLETA
  PARCIAL
}

enum EstadoAusencia {
  PENDIENTE
  APROBADA
  RECHAZADA
}

enum TipoDocumentoEmpleado {
  DNI
  CUIL
  CONTRATO
  ALTA_AFIP
  ART
  CV
  CERTIFICADO
  OTRO
}

// ─── Auditoría y Controles Internos ─────────────────────────────────────────

model AuditLog {
  id             String   @id @default(cuid())
  entidad        String   // "FacturaCompra", "AsientoContable", "Empleado", etc
  entidadId      String   // ID del registro
  accion         String   // "CREAR", "EDITAR", "ELIMINAR", "CAMBIO_ESTADO", "APROBAR", "RECHAZAR"
  campo          String?  // qué campo cambió
  valorAnterior  String?  // valor viejo (JSON)
  valorNuevo     String?  // valor nuevo (JSON)
  usuarioId      String
  usuario        User     @relation(fields: [usuarioId], references: [id])
  ip             String?
  userAgent      String?
  facturaCompra  FacturaCompra? @relation(fields: [facturaCompraId], references: [id])
  facturaCompraId String?
  createdAt      DateTime @default(now())

  @@index([entidad, entidadId])
  @@index([usuarioId])
  @@index([createdAt])
}

model PeriodoContable {
  id          String    @id @default(cuid())
  mes         Int       // 1-12
  anio        Int
  cerrado     Boolean   @default(false)
  cerradoPor  String?
  cerrador    User?     @relation(fields: [cerradoPor], references: [id])
  fechaCierre DateTime?
  motivo      String?   // Por qué se cerró
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([mes, anio])
  @@index([cerrado])
}

model DiagnosticoRun {
  id           String   @id @default(cuid())
  fecha        DateTime @default(now())
  duracion     Int      // segundos que tardó
  totalChecks  Int
  passed       Int
  warnings     Int
  errors       Int
  resultados   Json     // array con todos los checks
  ejecutadoPor String
  ejecutador   User     @relation(fields: [ejecutadoPor], references: [id])
  createdAt    DateTime @default(now())

  @@index([fecha])
  @@index([ejecutadoPor])
}

// ─── Gestión de Flota ───────────────────────────────────────────────────────

model Amortizacion {
  id                  String   @id @default(cuid())
  motoId              String
  moto                Moto     @relation(fields: [motoId], references: [id], onDelete: Cascade)
  periodo             String   // "2026-01"
  anioNumero          Int
  valorInicio         Decimal  @db.Decimal(12,2)
  cuotaAmortizacion   Decimal  @db.Decimal(12,2)
  amortizacionAcum    Decimal  @db.Decimal(12,2)
  valorResidualActual Decimal  @db.Decimal(12,2)
  createdAt           DateTime @default(now())

  @@unique([motoId, periodo])
  @@index([motoId])
  @@index([periodo])
}

model DocumentoMoto {
  id               String    @id @default(cuid())
  motoId           String
  moto             Moto      @relation(fields: [motoId], references: [id], onDelete: Cascade)
  tipo             TipoDocumentoMoto
  nombre           String
  url              String?
  fechaEmision     DateTime?
  fechaVencimiento DateTime?
  notas            String?
  completado       Boolean   @default(false) // Para checklist patentamiento
  createdAt        DateTime  @default(now())

  @@index([motoId])
  @@index([tipo])
}

model HistorialEstadoMoto {
  id             String   @id @default(cuid())
  motoId         String
  moto           Moto     @relation(fields: [motoId], references: [id], onDelete: Cascade)
  estadoAnterior String
  estadoNuevo    String
  motivo         String?
  usuarioId      String?
  usuario        User?    @relation(fields: [usuarioId], references: [id])
  createdAt      DateTime @default(now())

  @@index([motoId])
  @@index([createdAt])
}

model BajaMoto {
  id              String   @id @default(cuid())
  motoId          String   @unique
  moto            Moto     @relation(fields: [motoId], references: [id], onDelete: Cascade)
  tipoBaja        TipoBaja
  fechaBaja       DateTime
  motivo          String?

  // ─── ROBO ───────────────────────────────────────────────────────────────
  numeroDenuncia  String?
  comisaria       String?
  fechaDenuncia   DateTime?

  // ─── SINIESTRO ──────────────────────────────────────────────────────────
  numeroSiniestro String?
  aseguradora     String?
  montoIndemnizacion Decimal? @db.Decimal(12,2)
  fechaSiniestro  DateTime?

  // ─── VENTA ──────────────────────────────────────────────────────────────
  compradorNombre String?
  compradorDNI    String?
  compradorTelefono String?
  precioVenta     Decimal? @db.Decimal(12,2)
  formaPago       FormaPagoBaja?

  // ─── Documentación ──────────────────────────────────────────────────────
  archivoUrl      String?
  notas           String?

  registradoPor   String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([motoId])
  @@index([tipoBaja])
  @@index([fechaBaja])
}

model NotaCredito {
  id                String   @id @default(cuid())
  numero            String   @unique // Auto-generado NC-0001
  tipo              TipoNotaCredito
  facturaOriginalId String?
  clienteId         String
  cliente           Cliente  @relation(fields: [clienteId], references: [id])
  monto             Decimal  @db.Decimal(12,2)
  montoNeto         Decimal? @db.Decimal(12,2)
  montoIva          Decimal? @db.Decimal(12,2)
  motivo            String
  estado            EstadoNotaCredito @default(EMITIDA)
  aplicadaAId       String?  // Factura/pago donde se aplicó
  fechaEmision      DateTime @default(now())
  fechaAplicacion   DateTime?
  creadoPor         String?
  creador           User?    @relation(fields: [creadoPor], references: [id])
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([clienteId])
  @@index([estado])
  @@index([numero])
}

enum TipoDocumentoMoto {
  CEDULA_VERDE
  CEDULA_AZUL
  TITULO
  POLIZA
  VTV
  DESPACHO_IMPORTACION
  FACTURA_COMPRA
  VERIFICACION_POLICIAL
  FORMULARIO_01
  FORMULARIO_12
  CERTIFICADO_IMPORTACION
}

enum TipoBaja {
  ROBO
  SINIESTRO
  VENTA
}

enum FormaPagoBaja {
  EFECTIVO
  TRANSFERENCIA
  CHEQUE
}

enum TipoNotaCredito {
  DEVOLUCION_TOTAL
  DEVOLUCION_PARCIAL
  DESCUENTO
  AJUSTE_PRECIO
}

enum EstadoNotaCredito {
  EMITIDA
  APLICADA
  REEMBOLSADA
  ANULADA
}

// ==========================================
// SISTEMA DE MANTENIMIENTOS - MÓDULO COMPLETO
// ==========================================

// ─── PLANES DE MANTENIMIENTO (Templates) ──────────────────────────────────

model PlanMantenimiento {
  id              String   @id @default(cuid())
  nombre          String   // "Service Básico", "Service Intermedio", "Service Mayor"
  tipo            TipoService  // BASICO, INTERMEDIO, MAYOR
  descripcion     String?
  kmDesde         Int      // Rango de km donde aplica este plan (ej: 0)
  kmHasta         Int      // (ej: 4999 para básico)
  activo          Boolean  @default(true)

  tareas          TareaPlan[]
  ordenesTrabajo  OrdenTrabajo[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

enum TipoService {
  BASICO
  INTERMEDIO
  MAYOR
}

model TareaPlan {
  id              String   @id @default(cuid())
  planId          String
  plan            PlanMantenimiento @relation(fields: [planId], references: [id], onDelete: Cascade)

  nombre          String   // "Cambio de aceite motor"
  descripcion     String?  // Instrucciones detalladas
  categoria       CategoriaTarea  // MOTOR, FRENOS, TRANSMISION, ELECTRICO, NEUMATICOS, GENERAL
  orden           Int      // Orden de ejecución dentro del plan
  obligatoria     Boolean  @default(true)
  tiempoEstimado  Int?     // Minutos estimados

  // Repuesto sugerido para esta tarea
  repuestoSugeridoId String?
  repuestoSugerido   Repuesto? @relation(fields: [repuestoSugeridoId], references: [id])
  cantidadRepuesto   Decimal?  @db.Decimal(10,4) // Cantidad del repuesto (ej: 0.8 litros de aceite)

  tareasOT           TareaOrdenTrabajo[]
  repuestosTareaPlan RepuestoTareaPlan[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

enum CategoriaTarea {
  MOTOR
  FRENOS
  TRANSMISION
  ELECTRICO
  NEUMATICOS
  SUSPENSION
  CARROCERIA
  GENERAL
}

// ─── CITAS DE MANTENIMIENTO ──────────────────────────────────────

model CitaMantenimiento {
  id              String   @id @default(cuid())
  motoId          String
  moto            Moto     @relation(fields: [motoId], references: [id])
  riderId         String?  // Cliente/rider asignado a la moto
  rider           Cliente? @relation(fields: [riderId], references: [id])

  // Programación
  fechaProgramada DateTime // Fecha y hora programada
  fechaOriginal   DateTime // Fecha original (antes de reprogramaciones)
  lugarId         String?  // Taller asignado
  lugar           Taller?  @relation(fields: [lugarId], references: [id])

  // Estado
  estado          EstadoCita @default(PROGRAMADA)
  motivoReprogramacion String? // Si el rider pidió cambio
  motivoInasistencia   String? // Si no se presentó
  vecesReprogramada    Int     @default(0)
  maxReprogramaciones  Int     @default(2) // Máximo de veces que puede reprogramar

  // QR
  codigoQR        String   @unique @default(cuid()) // Código único para generar QR
  qrEscaneado     Boolean  @default(false)
  qrEscaneadoAt   DateTime?
  qrEscaneadoPor  String?  // Usuario que escaneó

  // Vinculación con la OT que se genera
  ordenTrabajoId  String?  @unique
  ordenTrabajo    OrdenTrabajo? @relation(fields: [ordenTrabajoId], references: [id])

  // Notificaciones
  notificacion7dias  Boolean @default(false) // Se envió notif 7 días antes
  notificacion3dias  Boolean @default(false) // Se envió notif 3 días antes
  notificacion1dia   Boolean @default(false) // Se envió notif 1 día antes
  notificacionDia    Boolean @default(false) // Se envió notif el mismo día

  notificaciones  NotificacionMantenimiento[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([motoId, estado])
  @@index([fechaProgramada])
  @@index([estado])
}

enum EstadoCita {
  PROGRAMADA           // Sistema la creó automáticamente
  NOTIFICADA           // Se envió notificación al rider
  CONFIRMADA           // Rider confirmó asistencia
  REPROGRAMADA         // Rider solicitó cambio (nueva fecha asignada)
  EN_PROCESO           // Rider hizo check-in, moto en taller
  COMPLETADA           // Service terminado, check-out hecho
  NO_ASISTIO           // Rider no se presentó
  CANCELADA            // Cancelada por admin
}

// ─── ORDENES DE TRABAJO ──────────────────────────────────────

model OrdenTrabajo {
  id              String   @id @default(cuid())
  numero          String   @unique // Auto-generado: OT-2026-00001

  motoId          String
  moto            Moto     @relation(fields: [motoId], references: [id])
  riderId         String?
  rider           Cliente? @relation("OrdenTrabajoRider", fields: [riderId], references: [id])

  // Tipo y plan
  tipoOT          TipoOT // PREVENTIVO, CORRECTIVO, EMERGENCIA
  prioridad       PrioridadOT       @default(MEDIA)
  planId          String?
  plan            PlanMantenimiento? @relation(fields: [planId], references: [id])
  tipoService     TipoService?      // BASICO, INTERMEDIO, MAYOR (determinado por km)

  // Estado
  estado          EstadoOT @default(SOLICITADA)

  // Kilometraje
  kmAlIngreso     Int      // Km de la moto al momento del check-in
  kmAlEgreso      Int?     // Km al salir (debería ser igual o muy similar)

  // Taller y mecánico
  tallerId        String?
  taller          Taller?  @relation(fields: [tallerId], references: [id])
  mecanicoId      String?
  mecanico        Mecanico? @relation(fields: [mecanicoId], references: [id])
  esExterno       Boolean  @default(false) // Taller externo o interno

  // Tiempos
  fechaProgramada DateTime?
  fechaIngreso    DateTime? // Check-in real
  fechaInicioTrabajo DateTime?
  fechaFinTrabajo DateTime?
  fechaEgreso     DateTime? // Check-out real
  tiempoInactividadHoras Decimal? @db.Decimal(8,2) // Calculado: fechaEgreso - fechaIngreso

  // Descripción
  descripcion     String?  // Descripción del problema (para correctivos)
  observacionesMecanico String? // Notas del mecánico al cerrar
  observacionesRecepcion String? // Notas de recepción

  // Costos
  costoRepuestos  Decimal  @default(0) @db.Decimal(12,2)
  costoManoObra   Decimal  @default(0) @db.Decimal(12,2)
  costoOtros      Decimal  @default(0) @db.Decimal(12,2) // Flete, grúa, etc.
  costoTotal      Decimal  @default(0) @db.Decimal(12,2) // Calculado
  costoACargoDel  ResponsableCosto @default(EMPRESA)

  // Detección de problema mayor
  problemaDetectado Boolean @default(false)
  descripcionProblema String?
  requiereReparacion  Boolean @default(false)
  ordenReparacionId   String? // Si genera una OT de reparación aparte

  // Puntaje del rider
  puntajeEstadoMoto    Decimal? @db.Decimal(5,2) // 0-100 basado en fotos de check-in
  detallesPuntaje      Json?   // Detalle del análisis de Claude Vision

  // Relaciones
  cita            CitaMantenimiento?
  tareas          TareaOrdenTrabajo[]
  repuestosUsados RepuestoOrdenTrabajo[]
  fotosCheckIn    FotoInspeccion[]  @relation("FotosCheckIn")
  fotosCheckOut   FotoInspeccion[]  @relation("FotosCheckOut")
  historial       HistorialOT[]
  puntajes        PuntajeRider[]

  // Firma/aceptación del rider
  riderAceptoEntrega Boolean @default(false)
  riderAceptoAt      DateTime?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([motoId])
  @@index([estado])
  @@index([tipoOT])
  @@index([fechaIngreso])
}

enum TipoOT {
  PREVENTIVO
  CORRECTIVO
  EMERGENCIA
}

enum PrioridadOT {
  BAJA
  MEDIA
  ALTA
  URGENTE
}

enum EstadoOT {
  SOLICITADA          // Creada, pendiente de evaluación
  APROBADA            // Validada, lista para planificación
  PROGRAMADA          // Con fecha y recursos confirmados
  EN_ESPERA_REPUESTOS // Bloqueada por falta de stock
  EN_EJECUCION        // Trabajo en curso
  EN_REVISION         // Pendiente control de calidad
  COMPLETADA          // Verificada y cerrada
  CANCELADA           // Cancelada
}

enum ResponsableCosto {
  EMPRESA  // Costo a cargo de MotoLibre (desgaste normal, preventivo)
  RIDER    // Costo a cargo del rider (accidente, mal uso)
  COMPARTIDO // Costo compartido
}

// ─── TAREAS DENTRO DE UNA OT ──────────────────────────────────────

model TareaOrdenTrabajo {
  id              String   @id @default(cuid())
  ordenTrabajoId  String
  ordenTrabajo    OrdenTrabajo @relation(fields: [ordenTrabajoId], references: [id], onDelete: Cascade)

  tareaPlanId     String?  // Referencia a la tarea del plan (si es preventivo)
  tareaPlan       TareaPlan? @relation(fields: [tareaPlanId], references: [id])

  nombre          String
  descripcion     String?
  categoria       CategoriaTarea
  orden           Int
  obligatoria     Boolean  @default(true)

  // Ejecución
  completada      Boolean  @default(false)
  completadaAt    DateTime?
  completadaPor   String?  // Mecánico que la ejecutó
  observaciones   String?
  resultado       ResultadoTarea? // APROBADO, REQUIERE_ATENCION, REPROBADO

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

enum ResultadoTarea {
  APROBADO
  REQUIERE_ATENCION
  REPROBADO
}

// ─── REPUESTOS USADOS EN UNA OT ──────────────────────────────────────

model RepuestoOrdenTrabajo {
  id              String   @id @default(cuid())
  ordenTrabajoId  String
  ordenTrabajo    OrdenTrabajo @relation(fields: [ordenTrabajoId], references: [id], onDelete: Cascade)

  repuestoId      String
  repuesto        Repuesto @relation(fields: [repuestoId], references: [id])

  cantidadPlanificada Decimal @db.Decimal(10,4) // Lo que se esperaba usar
  cantidadUsada       Decimal @default(0) @db.Decimal(10,4) // Lo que realmente se usó

  // Costos (para la empresa)
  costoUnitario       Decimal @default(0) @db.Decimal(12,2)
  costoTotal          Decimal @default(0) @db.Decimal(12,2) // cantidadUsada * costoUnitario

  // Precios (lo que se cobra al rider/cliente)
  precioUnitario      Decimal @default(0) @db.Decimal(12,2) // Resuelto por motor de pricing
  precioTotal         Decimal @default(0) @db.Decimal(12,2) // cantidadUsada * precioUnitario
  listaId             String? // Lista de precios usada (B2C, Rider, etc.)
  descuentoAplicadoPct Decimal @default(0) @db.Decimal(5,2) // % de descuento aplicado
  margenUnitario      Decimal @default(0) @db.Decimal(5,4) // (precioUnitario - costoUnitario) / precioUnitario

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([ordenTrabajoId, repuestoId])
}

// ─── REPUESTOS VINCULADOS A TAREAS DE PLAN ──────────────────────────────────────

model RepuestoTareaPlan {
  id              String   @id @default(cuid())
  tareaPlanId     String
  tareaPlan       TareaPlan @relation(fields: [tareaPlanId], references: [id], onDelete: Cascade)
  repuestoId      String
  repuesto        Repuesto @relation(fields: [repuestoId], references: [id])
  cantidad        Decimal  @default(1) @db.Decimal(10,4) // Cantidad requerida del repuesto
  tipoConsumo     TipoConsumoRepuesto @default(PLANIFICADO)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([tareaPlanId, repuestoId])
}

enum TipoConsumoRepuesto {
  PLANIFICADO   // Siempre se usa en este service
  CONDICIONAL   // Se usa solo si se detecta desgaste
  EXTRA         // Repuesto adicional no planificado
}

// ─── FOTOS DE INSPECCIÓN ──────────────────────────────────────

model FotoInspeccion {
  id              String   @id @default(cuid())

  // Vinculación (check-in o check-out)
  ordenTrabajoCheckInId  String?
  ordenTrabajoCheckIn    OrdenTrabajo? @relation("FotosCheckIn", fields: [ordenTrabajoCheckInId], references: [id])
  ordenTrabajoCheckOutId String?
  ordenTrabajoCheckOut   OrdenTrabajo? @relation("FotosCheckOut", fields: [ordenTrabajoCheckOutId], references: [id])

  tipo            TipoFoto // FRENTE, LATERAL_IZQ, LATERAL_DER, TRASERA, TABLERO, NEUMATICO_DEL, NEUMATICO_TRAS
  url             String   // URL en Cloudflare R2

  // Análisis de Claude Vision
  analizado       Boolean  @default(false)
  analisisResultado Json?  // Resultado completo del análisis
  kmDetectado     Int?     // Km leído del tablero (solo para tipo TABLERO)
  nivelDesgasteNeumatico Decimal? @db.Decimal(5,2) // 0-100% (solo para NEUMATICO_DEL y NEUMATICO_TRAS)
  danoDetectado   Boolean? // Si se detectó golpe/accidente
  descripcionDano String?  // Descripción del daño detectado

  subidoPor       String?  // Usuario que subió la foto
  subidoAt        DateTime @default(now())

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([ordenTrabajoCheckInId])
  @@index([ordenTrabajoCheckOutId])
}

enum TipoFoto {
  FRENTE
  LATERAL_IZQ
  LATERAL_DER
  TRASERA
  TABLERO
  NEUMATICO_DEL
  NEUMATICO_TRAS
}

// ─── TALLERES Y MECÁNICOS ──────────────────────────────────────

model Taller {
  id              String   @id @default(cuid())
  nombre          String
  direccion       String?
  telefono        String?
  email           String?
  tipo            TipoTaller // INTERNO, EXTERNO
  activo          Boolean  @default(true)

  // Capacidad
  capacidadDiaria Int      @default(10) // Cantidad de motos que puede atender por día
  horarioApertura String?  // "08:00"
  horarioCierre   String?  // "18:00"
  diasOperacion   String[] // ["LUN","MAR","MIE","JUE","VIE","SAB"]

  mecanicos       Mecanico[]
  citas           CitaMantenimiento[]
  ordenesTrabajo  OrdenTrabajo[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

enum TipoTaller {
  INTERNO
  EXTERNO
}

model Mecanico {
  id              String   @id @default(cuid())
  nombre          String
  telefono        String?
  email           String?
  especialidad    String?  // "Motor", "Electricidad", "General"
  tallerId        String
  taller          Taller   @relation(fields: [tallerId], references: [id])
  activo          Boolean  @default(true)
  tarifaHora      Decimal? @db.Decimal(12,2) // Tarifa por hora (para talleres internos)

  ordenesTrabajo  OrdenTrabajo[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// ─── HISTORIAL DE CAMBIOS EN OT ──────────────────────────────────────

model HistorialOT {
  id              String   @id @default(cuid())
  ordenTrabajoId  String
  ordenTrabajo    OrdenTrabajo @relation(fields: [ordenTrabajoId], references: [id], onDelete: Cascade)

  estadoAnterior  String?
  estadoNuevo     String
  accion          String   // "Creación", "Check-in", "Inicio trabajo", "Check-out", etc.
  detalle         String?
  realizadoPor    String?  // Usuario que realizó la acción

  createdAt       DateTime @default(now())
}

// ─── PUNTAJE DEL RIDER ──────────────────────────────────────

model PuntajeRider {
  id              String   @id @default(cuid())
  riderId         String
  rider           Cliente  @relation(fields: [riderId], references: [id])

  ordenTrabajoId  String
  ordenTrabajo    OrdenTrabajo @relation(fields: [ordenTrabajoId], references: [id])

  // Componentes del puntaje (0-100 cada uno)
  puntajeEstadoGeneral   Decimal @db.Decimal(5,2) // Basado en análisis de fotos (carrocería)
  puntajeNeumaticos      Decimal @db.Decimal(5,2) // Basado en análisis de desgaste
  puntajeAsistencia      Decimal @db.Decimal(5,2) // 100 si asistió a tiempo, 50 si reprogramó, 0 si no asistió
  puntajeKmCoherente     Decimal @db.Decimal(5,2) // Km del tablero vs km IoT (detecta manipulación)
  puntajeSinAccidentes   Decimal @db.Decimal(5,2) // 100 si no hay daños nuevos, menos según gravedad

  puntajeTotal           Decimal @db.Decimal(5,2) // Promedio ponderado

  observaciones          String?

  createdAt              DateTime @default(now())

  @@index([riderId])
}

// ─── LECTURAS DE KM (IoT) ──────────────────────────────────────

// TODO: Modelo definido pero sin endpoints — evaluar si se necesita
model LecturaKm {
  id              String   @id @default(cuid())
  motoId          String
  moto            Moto     @relation(fields: [motoId], references: [id])

  km              Int
  fuente          FuenteKm // IOT, MANUAL, FOTO (Claude Vision)

  createdAt       DateTime @default(now())

  @@index([motoId, createdAt])
}

enum FuenteKm {
  IOT
  MANUAL
  FOTO
}

// ─── NOTIFICACIONES DE MANTENIMIENTO ──────────────────────────────────────

// TODO: Modelo sin implementar — evaluar si se necesita
model NotificacionMantenimiento {
  id        String   @id @default(cuid())
  citaId    String
  cita      CitaMantenimiento @relation(fields: [citaId], references: [id])
  tipo      String   // "7_DIAS", "3_DIAS", "1_DIA", "DIA", "NO_ASISTIO"
  canal     String   // "EMAIL", "PUSH", "SMS", "SISTEMA"
  enviada   Boolean  @default(false)
  enviadaAt DateTime?
  error     String?

  createdAt DateTime @default(now())
}

// ==========================================
// GESTIÓN DE INVENTARIO V2
// ==========================================

// ─── UBICACIONES EN DEPÓSITO ────────────────────────────────────

model UbicacionDeposito {
  id        String   @id @default(cuid())
  codigo    String   @unique // "E2-F3-P1" (Estante 2, Fila 3, Posición 1)
  estante   String   // "E2"
  fila      String   // "F3"
  posicion  String   // "P1"
  nombre    String?  // "Estante Frenos", alias legible
  notas     String?
  activo    Boolean  @default(true)
  createdAt DateTime @default(now())
}

// ─── MOVIMIENTOS DE STOCK ───────────────────────────────────────

model MovimientoStock {
  id            String              @id @default(cuid())
  repuestoId    String
  repuesto      Repuesto            @relation(fields: [repuestoId], references: [id])
  tipo          TipoMovimientoStock
  cantidad      Int                 // Positivo = entrada, Negativo = salida
  stockAnterior Int                 // Stock antes del movimiento
  stockNuevo    Int                 // Stock después del movimiento
  motivo        String?             // "Recepción OC-001", "Consumo OT-045", "Ajuste inventario", "Importación CSV"
  referencia    String?             // ID de la OC, OT, o recepción que originó el movimiento
  usuario       String?             // Email del usuario que hizo el movimiento
  createdAt     DateTime            @default(now())

  @@index([repuestoId])
  @@index([createdAt])
}

enum TipoMovimientoStock {
  ENTRADA_COMPRA       // Llegó mercadería de una OC
  ENTRADA_AJUSTE       // Ajuste manual positivo (inventario)
  ENTRADA_DEVOLUCION   // Devolvieron un repuesto de una OT
  SALIDA_CONSUMO_OT    // Se usó en una Orden de Trabajo
  SALIDA_AJUSTE        // Ajuste manual negativo (inventario)
  SALIDA_ROTURA        // Se rompió o venció
  IMPORTACION          // Carga masiva desde CSV/Excel
}

// ─── ORDENES DE COMPRA ──────────────────────────────────────────

model OrdenCompra {
  id                   String            @id @default(cuid())
  visibleId            String            @unique @default(cuid())
  numero               String            @unique // "OC-001" autogenerado
  proveedorId          String
  proveedor            Proveedor         @relation(fields: [proveedorId], references: [id])
  estado               EstadoOrdenCompra @default(BORRADOR)
  fechaEmision         DateTime          @default(now())
  fechaEntregaEstimada DateTime?
  subtotal             Decimal           @default(0) @db.Decimal(12,2)
  iva                  Decimal           @default(0) @db.Decimal(12,2)
  total                Decimal           @default(0) @db.Decimal(12,2)
  notas                String?
  creadoPor            String?           // Email del usuario
  aprobadoPor          String?

  // ⭐ GAP 1: Vinculación opcional con embarque de importación
  embarqueId           String?
  embarque             EmbarqueImportacion? @relation(fields: [embarqueId], references: [id])

  createdAt            DateTime          @default(now())
  updatedAt            DateTime          @updatedAt
  items                ItemOrdenCompra[]
  recepciones          RecepcionMercaderia[]

  @@index([proveedorId])
  @@index([estado])
}

enum EstadoOrdenCompra {
  BORRADOR       // Se está armando
  PENDIENTE      // Enviada al proveedor, esperando
  PARCIAL        // Recibida parcialmente
  COMPLETADA     // Todo recibido
  CANCELADA      // Cancelada
}

model ItemOrdenCompra {
  id               String      @id @default(cuid())
  ordenCompraId    String
  ordenCompra      OrdenCompra @relation(fields: [ordenCompraId], references: [id], onDelete: Cascade)
  repuestoId       String
  repuesto         Repuesto    @relation(fields: [repuestoId], references: [id])
  cantidad         Int         // Cantidad pedida
  cantidadRecibida Int         @default(0) // Cantidad ya recibida (se actualiza con recepciones)
  precioUnitario   Decimal     @default(0) @db.Decimal(12,2)
  subtotal         Decimal     @default(0) @db.Decimal(12,2) // cantidad × precioUnitario
  createdAt        DateTime    @default(now())

  @@unique([ordenCompraId, repuestoId])
}

// ─── RECEPCIÓN DE MERCADERÍA ────────────────────────────────────

model RecepcionMercaderia {
  id             String            @id @default(cuid())
  visibleId      String            @unique @default(cuid())
  ordenCompraId  String?           // Puede ser recepción sin OC (ingreso directo)
  ordenCompra    OrdenCompra?      @relation(fields: [ordenCompraId], references: [id])
  numero         String            @unique // "REC-001"
  fechaRecepcion DateTime          @default(now())
  recibidoPor    String?           // Email
  notas          String?
  createdAt      DateTime          @default(now())
  items          ItemRecepcion[]
}

model ItemRecepcion {
  id                String              @id @default(cuid())
  recepcionId       String
  recepcion         RecepcionMercaderia @relation(fields: [recepcionId], references: [id], onDelete: Cascade)
  repuestoId        String
  repuesto          Repuesto            @relation(fields: [repuestoId], references: [id])
  cantidadEsperada  Int?                // Lo que decía la OC (null si es ingreso directo)
  cantidadRecibida  Int                 // Lo que realmente llegó
  cantidadRechazada Int                 @default(0) // Defectuosos / dañados
  ubicacionAsignada String?             // "E2-F3-P1" — dónde se guardó
  observaciones     String?
  createdAt         DateTime            @default(now())
}

// ==========================================
// COSTEO DE IMPORTACIÓN Y PRICING
// ==========================================

// ─── EMBARQUES DE IMPORTACIÓN ───────────────────────────────────

model EmbarqueImportacion {
  id                  String              @id @default(cuid())
  visibleId           String              @unique @default(cuid())
  referencia          String              @unique // "EMB-001" autogenerado
  proveedorId         String?
  proveedor           Proveedor?          @relation(fields: [proveedorId], references: [id])
  estado              EstadoEmbarque      @default(BORRADOR)
  metodoFlete         MetodoFlete

  // Fechas
  fechaSalida         DateTime?           // ETD
  fechaLlegadaEstimada DateTime?          // ETA
  fechaLlegadaReal    DateTime?

  // Contenedor
  numeroContenedor    String?
  tipoContenedor      String?             // "20GP", "40GP", "40HQ"

  // ─── Costos compartidos en USD ────────────────────────────────
  totalFobUsd         Decimal             @default(0) @db.Decimal(12,2)
  fleteUsd            Decimal             @default(0) @db.Decimal(12,2)
  seguroUsd           Decimal             @default(0) @db.Decimal(12,2)
  cifUsd              Decimal             @default(0) @db.Decimal(12,2) // FOB + Flete + Seguro

  // ─── Impuestos de aduana (calculados) ─────────────────────────
  derechosImportacion Decimal? @db.Decimal(12,2) // DIE — NO recuperable
  tasaEstadistica     Decimal? @db.Decimal(12,2) // 3% — NO recuperable
  ivaAduana           Decimal? @db.Decimal(12,2) // 21% — RECUPERABLE (crédito fiscal)
  ivaAdicional        Decimal? @db.Decimal(12,2) // 20% — RECUPERABLE
  gananciasAnticipado Decimal? @db.Decimal(12,2) // 6% — RECUPERABLE
  iibbAnticipado      Decimal? @db.Decimal(12,2) // ~3% — RECUPERABLE
  tasaOficializacion  Decimal? @db.Decimal(12,2) // USD $10 fijo — NO recuperable
  tasaDigitalizacion  Decimal? @db.Decimal(12,2) // USD $28 fijo — NO recuperable

  // ─── Gastos logísticos en USD ─────────────────────────────────
  despachanteFee      Decimal? @db.Decimal(12,2) // Honorarios despachante
  gastosPuerto        Decimal? @db.Decimal(12,2) // Terminal, almacenaje, etc
  transporteInterno   Decimal? @db.Decimal(12,2) // Flete interno hasta depósito
  otrosGastos         Decimal? @db.Decimal(12,2) // Otros gastos no categorizados
  otrosGastosDetalle  String?  // Descripción de otros gastos

  // ─── Tipo de cambio ───────────────────────────────────────────
  tipoCambioArsUsd    Decimal? @db.Decimal(10,4) // TC Banco Nación vendedor al momento del despacho
  fechaDespacho       DateTime?
  numeroDespacho      String?  // Número de despacho aduanero

  // ─── Totales calculados ───────────────────────────────────────
  costoTotalNoRecuperable Decimal? @db.Decimal(12,2) // Todo lo que suma al costo del inventario
  costoTotalRecuperable   Decimal? @db.Decimal(12,2) // IVA + Ganancias + IIBB (crédito fiscal)
  desembolsoTotal         Decimal? @db.Decimal(12,2) // Total que se paga en aduana

  // ─── Cantidad de despachos parciales ──────────────────────────
  cantidadDespachos       Int     @default(1)

  notas               String?

  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  items                ItemEmbarque[]
  despachos            DespachoAduanero[]
  asignaciones         AsignacionCostoImportacion[]
  ordenesCompra        OrdenCompra[]  // ⭐ GAP 1: OCs vinculadas a este embarque
  recepcion            RecepcionMercaderiaEmbarque?
  portalToken          PortalProveedorToken?
  etiquetas            EtiquetaEmbarque[]

  @@index([proveedorId])
  @@index([estado])
}

enum EstadoEmbarque {
  BORRADOR
  EN_TRANSITO
  EN_PUERTO
  EN_ADUANA
  DESPACHADO_PARCIAL
  COSTO_FINALIZADO
  RECIBIDO              // Llegó al almacén, pendiente de revisión
  EN_RECEPCION          // En proceso de control de calidad
  RECEPCION_PARCIAL     // Algunos items recibidos, otros pendientes
  ALMACENADO            // Todos los items verificados y ubicados
}

enum MetodoFlete {
  MARITIMO_FCL    // Contenedor completo
  MARITIMO_LCL   // Carga consolidada
  AEREO           // Avión
}

// ─── ITEMS DEL EMBARQUE ─────────────────────────────────────────

model ItemEmbarque {
  id              String             @id @default(cuid())
  embarqueId      String
  embarque        EmbarqueImportacion @relation(fields: [embarqueId], references: [id], onDelete: Cascade)
  repuestoId      String?
  repuesto        Repuesto?          @relation(fields: [repuestoId], references: [id])

  cantidad        Int                // Cantidad importada
  precioFobUnitarioUsd Decimal        @db.Decimal(12,2) // Precio FOB por unidad en USD
  subtotalFobUsd  Decimal            @db.Decimal(12,2) // cantidad × precioFobUnitario
  pesoTotalKg     Decimal?           @db.Decimal(10,4) // Peso total de esta línea
  volumenTotalCbm Decimal?           @db.Decimal(10,6) // Volumen total de esta línea
  ncmCodigo       String?            // NCM específico (override del repuesto)
  arancelPorcentaje Decimal?         @db.Decimal(5,2) // % arancel específico (override de categoría)

  // ─── Costos asignados (se calculan al finalizar) ──────────────
  costoAsignadoFlete    Decimal?     @db.Decimal(12,2) // Flete prorrateado a esta línea
  costoAsignadoSeguro   Decimal?     @db.Decimal(12,2)
  costoAsignadoDerechos Decimal?     @db.Decimal(12,2)
  costoAsignadoTasas    Decimal?     @db.Decimal(12,2)
  costoAsignadoLogistica Decimal?    @db.Decimal(12,2)

  costoLandedUnitarioUsd Decimal?    @db.Decimal(12,2) // Costo puesto en almacén por unidad (USD)
  costoLandedUnitarioArs Decimal?    @db.Decimal(12,2) // Costo puesto en almacén por unidad (ARS)

  createdAt       DateTime           @default(now())

  recepcionItem   RecepcionItemEmbarque?
  etiquetas       EtiquetaEmbarque[]

  @@index([embarqueId])
  @@index([repuestoId])
}

// ─── DESPACHOS ADUANEROS (parciales) ────────────────────────────

model DespachoAduanero {
  id                  String             @id @default(cuid())
  embarqueId          String
  embarque            EmbarqueImportacion @relation(fields: [embarqueId], references: [id])
  numeroDespacho      String             @unique
  fecha               DateTime
  tipoCambio          Decimal            @db.Decimal(10,4) // TC BNA vendedor en la fecha
  cifParcialUsd       Decimal            @db.Decimal(12,2) // CIF de lo despachado en este despacho
  derechosPagados     Decimal            @default(0) @db.Decimal(12,2)
  tasaEstadistica     Decimal            @default(0) @db.Decimal(12,2)
  ivaPagado           Decimal            @default(0) @db.Decimal(12,2)
  ivaAdicionalPagado  Decimal            @default(0) @db.Decimal(12,2)
  gananciasPagado     Decimal            @default(0) @db.Decimal(12,2)
  iibbPagado          Decimal            @default(0) @db.Decimal(12,2)
  tasaOficializacion  Decimal            @default(10) @db.Decimal(12,2) // USD 10
  tasaDigitalizacion  Decimal            @default(28) @db.Decimal(12,2) // USD 28
  gastosDespachante   Decimal?           @db.Decimal(12,2)
  otrosGastos         Decimal?           @db.Decimal(12,2)
  notas               String?

  // Items despachados en este despacho parcial
  itemsDespachados    Json?              // [{ repuestoId, cantidad }]

  createdAt           DateTime           @default(now())

  @@index([embarqueId])
}

// ─── ASIGNACIÓN DE COSTOS POR REPUESTO ──────────────────────────

model AsignacionCostoImportacion {
  id                  String             @id @default(cuid())
  embarqueId          String
  embarque            EmbarqueImportacion @relation(fields: [embarqueId], references: [id])
  repuestoId          String
  repuesto            Repuesto           @relation(fields: [repuestoId], references: [id])

  cantidad            Int
  fobUnitarioUsd      Decimal @db.Decimal(12,2)
  fleteUnitarioUsd    Decimal @db.Decimal(12,2)
  seguroUnitarioUsd   Decimal @db.Decimal(12,2)
  derechosUnitarioUsd Decimal @db.Decimal(12,2)
  tasasUnitarioUsd    Decimal @db.Decimal(12,2)
  logisticaUnitarioUsd Decimal @db.Decimal(12,2)

  // Totales por unidad
  costoLandedUnitarioUsd Decimal        @db.Decimal(12,2) // Solo costos no recuperables
  costoLandedUnitarioArs Decimal        @db.Decimal(12,2) // Convertido a ARS al TC del despacho
  desembolsoUnitarioUsd  Decimal        @db.Decimal(12,2) // Incluyendo recuperables (cash flow)

  metodoAsignacion    String            // "POR_VALOR", "POR_VOLUMEN", "POR_PESO", "HIBRIDO"
  tipoCambioUsado     Decimal @db.Decimal(10,4)

  createdAt           DateTime          @default(now())

  @@index([embarqueId])
  @@index([repuestoId])
}

// ─── RECEPCIÓN DE MERCADERÍA (WORKFLOW ALMACÉN) ─────────────────

model RecepcionMercaderiaEmbarque {
  id              String   @id @default(cuid())
  embarqueId      String   @unique
  embarque        EmbarqueImportacion @relation(fields: [embarqueId], references: [id], onDelete: Cascade)

  // Usuario que realiza la recepción
  usuarioId       String?
  usuario         User? @relation(fields: [usuarioId], references: [id])

  // Fechas
  fechaInicio     DateTime @default(now())  // Cuando se inicia la recepción
  fechaFinalizada DateTime?                  // Cuando se completa

  // Totales de control
  totalItemsEsperados  Int      @default(0)  // Total de líneas en el embarque
  totalItemsRecibidos  Int      @default(0)  // Líneas ya procesadas
  totalItemsRechazados Int      @default(0)  // Líneas con problemas

  // Observaciones generales
  observaciones   String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  items           RecepcionItemEmbarque[]
}

model RecepcionItemEmbarque {
  id                String   @id @default(cuid())
  recepcionId       String
  recepcion         RecepcionMercaderiaEmbarque @relation(fields: [recepcionId], references: [id], onDelete: Cascade)

  // Vinculación al item del embarque
  itemEmbarqueId    String       @unique
  itemEmbarque      ItemEmbarque @relation(fields: [itemEmbarqueId], references: [id])

  repuestoId        String
  repuesto          Repuesto @relation(fields: [repuestoId], references: [id])

  // Control de cantidades
  cantidadEsperada  Int       // De la packing list
  cantidadRecibida  Int       // Lo que realmente llegó OK
  cantidadRechazada Int       @default(0)  // Defectuosos/dañados
  cantidadFaltante  Int       @default(0)  // Diferencia negativa

  // Control de calidad
  estadoItem        EstadoRecepcionItem @default(PENDIENTE)
  motivoRechazo     String?   // Si hay cantidadRechazada > 0

  // Control de peso
  pesoEsperadoKg    Decimal?  @db.Decimal(10,4) // Peso esperado del packing list
  pesoRecibidoKg    Decimal?  @db.Decimal(10,4) // Peso real recibido
  alertaPeso        Boolean   @default(false)  // True si difiere >10%

  // Ubicación en depósito
  ubicacionAsignada String?   // Formato: "E2-F3-P1" (Estante-Fila-Posición)

  // Usuario que procesó este item
  procesadoPor      String?   // Email del usuario
  fechaProcesado    DateTime?

  // Observaciones específicas de este item
  observaciones     String?

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@unique([recepcionId, itemEmbarqueId])
  @@index([recepcionId])
  @@index([repuestoId])
}

enum EstadoRecepcionItem {
  PENDIENTE       // No procesado aún
  RECIBIDO_OK     // Cantidad correcta, sin problemas
  RECIBIDO_PARCIAL // Algunos OK, algunos con problemas
  RECHAZADO_TOTAL  // Todo el lote rechazado
  FALTANTE         // No llegó nada de este item
}

// ─── PORTAL DE PROVEEDOR ────────────────────────────────────────

model PortalProveedorToken {
  id           String   @id @default(cuid())
  embarqueId   String   @unique
  embarque     EmbarqueImportacion @relation(fields: [embarqueId], references: [id], onDelete: Cascade)
  token        String   @unique @default(cuid())
  activo       Boolean  @default(true)
  vistoPor     String?  // IP o user agent del proveedor
  vistoAt      DateTime?
  confirmado   Boolean  @default(false)
  confirmadoAt DateTime?
  createdAt    DateTime @default(now())

  @@index([token])
  @@index([embarqueId])
}

// ─── ETIQUETAS DE EMBARQUE ──────────────────────────────────────

model EtiquetaEmbarque {
  id          String   @id @default(cuid())
  embarqueId  String
  embarque    EmbarqueImportacion @relation(fields: [embarqueId], references: [id], onDelete: Cascade)
  itemId      String?
  item        ItemEmbarque? @relation(fields: [itemId], references: [id], onDelete: Cascade)
  tipo        TipoEtiqueta // "INDIVIDUAL" | "CAJA" | "MASTER"
  codigoQr    String   @unique // UUID para el QR
  datos       Json     // datos codificados en el QR
  impreso     Boolean  @default(false)
  createdAt   DateTime @default(now())

  @@index([embarqueId])
  @@index([codigoQr])
}

enum TipoEtiqueta {
  INDIVIDUAL  // Etiqueta individual (5cm x 3cm)
  CAJA        // Etiqueta de caja (10cm x 7cm)
  MASTER      // Etiqueta master box (15cm x 10cm)
}

// ─── HISTORIAL DE COSTOS ────────────────────────────────────────

model HistorialCostoRepuesto {
  id                  String   @id @default(cuid())
  repuestoId          String
  repuesto            Repuesto @relation(fields: [repuestoId], references: [id])

  costoAnteriorArs    Decimal  @db.Decimal(12,2)
  costoNuevoArs       Decimal  @db.Decimal(12,2)
  costoAnteriorUsd    Decimal? @db.Decimal(12,2)
  costoNuevoUsd       Decimal? @db.Decimal(12,2)
  cantidadAnterior    Int
  cantidadNueva       Int

  motivo              String   // "IMPORTACION", "AJUSTE_MANUAL", "CORRECCION", "RECEPCION_LOCAL"
  referencia          String?  // ID del embarque, OC, o ajuste que originó el cambio
  tipoCambio          Decimal? @db.Decimal(10,4)
  usuario             String?  // Email del usuario

  createdAt           DateTime @default(now())

  @@index([repuestoId, createdAt])
}

// ==========================================
// MOTOR DE PRICING — REPUESTOS
// ==========================================

// ─── LISTAS DE PRECIOS ──────────────────────────────────────────

model ListaPrecio {
  id              String           @id @default(cuid())
  nombre          String           // "B2C Retail", "Rider Activo", "Taller Externo", "Uso Interno"
  codigo          String           @unique // "B2C", "RIDER", "TALLER", "INTERNO"
  tipo            TipoListaPrecio
  moneda          String           @default("ARS")
  activa          Boolean          @default(true)
  prioridad       Int              @default(0) // Mayor prioridad = se evalúa primero
  descripcion     String?

  // Descuento global de la lista (% sobre precio retail)
  descuentoGlobalPct Decimal?      @db.Decimal(5,4) // Ej: 0.15 = 15% off retail

  // Auto-cálculo basado en costo (GAP 3)
  autoCalcular    Boolean          @default(false) // Si true, calcula precio automáticamente
  formulaMarkup   Decimal?         @db.Decimal(5,4) // Factor multiplicador sobre costo. Ej: 1.05 = costo + 5%

  // Vigencia opcional
  vigenciaDesde   DateTime?
  vigenciaHasta   DateTime?

  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  items           ItemListaPrecio[]
  reglasDescuento ReglaDescuento[]
  gruposCliente   GrupoCliente[]
}

enum TipoListaPrecio {
  RETAIL        // Precio público B2C (base para las demás)
  PREFERENCIAL  // Descuento para riders activos
  MAYORISTA     // Para talleres y mecánicos externos
  INTERNO       // Uso interno de la flota propia
  PERSONALIZADA // Negociación específica
}

// ─── ITEMS DE LISTA DE PRECIOS ──────────────────────────────────

model ItemListaPrecio {
  id              String       @id @default(cuid())
  listaPrecioId   String
  listaPrecio     ListaPrecio  @relation(fields: [listaPrecioId], references: [id], onDelete: Cascade)
  repuestoId      String
  repuesto        Repuesto     @relation(fields: [repuestoId], references: [id])

  precioArs       Decimal      @db.Decimal(12,2) // Precio final en ARS para esta lista
  precioUsd       Decimal?     @db.Decimal(12,2) // Precio en USD (referencial)

  // Cantidad mínima para este precio (permite escalonado)
  cantidadMinima  Int          @default(1)

  // Vigencia temporal
  vigenciaDesde   DateTime     @default(now())
  vigenciaHasta   DateTime?

  // Metadata de cálculo (para auditoría: cómo se llegó a este precio)
  costoBase       Decimal?     @db.Decimal(12,2) // Costo al momento de calcular
  markupAplicado  Decimal?     @db.Decimal(5,4) // Multiplicador aplicado
  descuentoAplicado Decimal?   @db.Decimal(5,4) // % de descuento aplicado
  metodoCalculo   String?      // "MARKUP_CATEGORIA", "MARKUP_BANDA", "MANUAL", "BULK_UPDATE"

  createdAt       DateTime     @default(now())

  @@unique([listaPrecioId, repuestoId, cantidadMinima, vigenciaDesde])
  @@index([listaPrecioId, repuestoId])
  @@index([vigenciaDesde, vigenciaHasta])
}

// ─── REGLAS DE MARKUP ───────────────────────────────────────────

model ReglaMarkup {
  id              String   @id @default(cuid())
  nombre          String   // "Banda $0-$5", "Banda $5-$75", etc.
  
  // Condiciones (al menos una debe aplicar)
  categoria       String?  // Si null, aplica a todas las categorías
  costoBandaDesde Decimal? @db.Decimal(12,2) // Rango de costo unitario (en ARS)
  costoBandaHasta Decimal? @db.Decimal(12,2)
  esOEM           Boolean? // null = ambos, true = solo OEM, false = solo genérico

  // Acción
  multiplicador   Decimal  @db.Decimal(5,4) // Ej: 2.5 = precio = costo × 2.5
  redondeo        String?  // "NEAREST_10", "NEAREST_50", "NEAREST_99", "NONE"

  prioridad       Int      @default(0) // Mayor = se evalúa primero
  activa          Boolean  @default(true)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([categoria])
}

// ─── REGLAS DE DESCUENTO ────────────────────────────────────────

model ReglaDescuento {
  id              String       @id @default(cuid())
  nombre          String       // "Descuento Plan Premium", "Antigüedad 1+ año"
  listaPrecioId   String?      // Si null, aplica a todas las listas
  listaPrecio     ListaPrecio? @relation(fields: [listaPrecioId], references: [id])

  // ─── Condiciones ──────────────────────────────────────────────
  tipoCondicion   TipoCondicionDescuento
  
  // Para PLAN_ALQUILER: qué plan tiene el rider
  planAlquiler    String?      // "BASICO", "PREMIUM", "VIP" (match contra contrato activo)
  
  // Para ANTIGUEDAD: meses mínimos como cliente activo
  antiguedadMeses Int?         // 6, 12, 24, 60
  
  // Para CATEGORIA: aplica solo a una categoría de repuesto
  categoria       String?
  
  // Para CANTIDAD: compras mayores a X unidades
  cantidadMinima  Int?

  // ─── Acción ───────────────────────────────────────────────────
  tipoDescuento   TipoDescuento
  valorDescuento  Decimal      @db.Decimal(12,2) // Porcentaje (0.10 = 10%) o monto fijo en ARS

  // ─── Guardrails ───────────────────────────────────────────────
  margenMinimo    Decimal?     @db.Decimal(5,4) // No aplicar si el margen cae por debajo de esto
  acumulable      Boolean      @default(false) // ¿Se puede combinar con otros descuentos?

  prioridad       Int          @default(0)
  activa          Boolean      @default(true)
  vigenciaDesde   DateTime?
  vigenciaHasta   DateTime?

  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
}

enum TipoCondicionDescuento {
  PLAN_ALQUILER     // Según el plan de alquiler del rider
  ANTIGUEDAD        // Meses como cliente activo
  CATEGORIA         // Categoría de repuesto
  CANTIDAD          // Volumen de compra
  GRUPO_CLIENTE     // Pertenencia a grupo
  SIEMPRE           // Se aplica siempre (descuento de la lista)
}

enum TipoDescuento {
  PORCENTAJE        // 10% off
  MONTO_FIJO        // $500 off
}

// ─── GRUPOS DE CLIENTES ─────────────────────────────────────────

model GrupoCliente {
  id              String       @id @default(cuid())
  nombre          String       @unique // "Riders Activos", "Talleres Externos", "VIP"
  descripcion     String?
  listaPrecioId   String?      // Lista de precios asignada por defecto
  listaPrecio     ListaPrecio? @relation(fields: [listaPrecioId], references: [id])
  descuentoExtra  Decimal?     @db.Decimal(5,4) // Descuento adicional sobre la lista
  activo          Boolean      @default(true)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  miembros        MiembroGrupoCliente[]
}

model MiembroGrupoCliente {
  id              String       @id @default(cuid())
  grupoId         String
  grupo           GrupoCliente @relation(fields: [grupoId], references: [id], onDelete: Cascade)
  clienteId       String
  cliente         Cliente      @relation(fields: [clienteId], references: [id])
  fechaIngreso    DateTime     @default(now())

  @@unique([grupoId, clienteId])
}

// ─── HISTORIAL DE PRECIOS ───────────────────────────────────────

model HistorialPrecioRepuesto {
  id              String   @id @default(cuid())
  repuestoId      String
  repuesto        Repuesto @relation(fields: [repuestoId], references: [id])
  listaPrecioId   String?  // null = precio general (precioVenta del repuesto)

  precioAnterior  Decimal? @db.Decimal(12,2)
  precioNuevo     Decimal  @db.Decimal(12,2)
  
  tipoCambio      String   // "MANUAL", "BULK_UPDATE", "RECALCULO_COSTO", "REGLA_MARKUP", "IMPORTACION"
  motivo          String?  // "Actualización por embarque EMB-003", "Ajuste inflación +15%"
  loteId          String?  // Agrupa cambios bulk (para rollback)

  // Snapshot al momento del cambio
  costoAlMomento  Decimal? @db.Decimal(12,2)
  margenAlMomento Decimal? @db.Decimal(5,4) // (precio - costo) / precio

  usuario         String   // Email del usuario
  createdAt       DateTime @default(now())

  @@index([repuestoId, createdAt])
  @@index([loteId])
  @@index([createdAt])
}

// ─── LOTES DE CAMBIO DE PRECIO (para rollback) ─────────────────

model LoteCambioPrecio {
  id              String   @id @default(cuid())
  descripcion     String   // "Ajuste inflación Marzo 2026", "Recálculo post EMB-003"
  tipo            String   // "BULK_PORCENTAJE", "BULK_MARKUP", "RECALCULO_COSTO", "ROLLBACK"
  
  cantidadItems   Int      // Cuántos repuestos afectó
  parametros      Json?    // { porcentaje: 15, categorias: ["FRENOS", "MOTOR"] }
  
  aplicado        Boolean  @default(false) // false = preview, true = confirmado
  revertido       Boolean  @default(false) // true = se hizo rollback
  revertidoPor    String?  // Lote ID del rollback

  usuario         String
  createdAt       DateTime @default(now())
}

// ─── Event Bus ──────────────────────────────────────────────────────────────

model BusinessEvent {
  id            String    @id @default(cuid())
  operationId   String    // "payment.approve", "rental.contract.create"
  entityType    String    // "Payment", "Contrato", "Factura"
  entityId      String    // ID de la entidad afectada
  payload       Json      // Datos del evento (snapshot de la entidad)
  metadata      Json?     // Info adicional (IP, user agent, etc)
  userId        String?   // Quien disparó el evento (null = sistema)
  parentEventId String?   // Para eventos que son consecuencia de otro
  status        EstadoBusinessEvent @default(PENDING)
  error         String?   // Si un handler falló (JSON array de errores)
  processedAt   DateTime?
  createdAt     DateTime  @default(now())

  parentEvent   BusinessEvent?  @relation("EventChain", fields: [parentEventId], references: [id])
  childEvents   BusinessEvent[] @relation("EventChain")
  user          User?           @relation(fields: [userId], references: [id])

  @@index([operationId])
  @@index([entityType, entityId])
  @@index([status])
  @@index([createdAt])
  @@index([parentEventId])
}

enum EstadoBusinessEvent {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

// ─── Permissions ────────────────────────────────────────────────────────────

model Operation {
  id               String   @id @default(cuid())
  code             String   @unique // "fleet.moto.create"
  family           String   // "fleet" (primer segmento)
  entity           String   // "moto" (segundo segmento)
  action           String   // "create" (tercer segmento)
  description      String   // "Crear moto en el sistema"
  requiresApproval Boolean  @default(false)
  isViewOnly       Boolean  @default(false)
  createdAt        DateTime @default(now())

  permissions      PermissionGrant[]

  @@index([family])
}

model PermissionProfile {
  id          String   @id @default(cuid())
  name        String   @unique // "Contador", "Operador Flota"
  description String?
  isSystem    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  grants      PermissionGrant[]
  users       UserProfile[]
}

model PermissionGrant {
  id          String  @id @default(cuid())
  profileId   String
  operationId String
  canView     Boolean @default(false)
  canCreate   Boolean @default(false)
  canExecute  Boolean @default(false)
  canApprove  Boolean @default(false)

  profile     PermissionProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  operation   Operation         @relation(fields: [operationId], references: [id], onDelete: Cascade)

  @@unique([profileId, operationId])
}

model UserProfile {
  id         String   @id @default(cuid())
  userId     String
  profileId  String
  assignedBy String?
  assignedAt DateTime @default(now())

  user    User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  profile PermissionProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@unique([userId, profileId])
}

// ─── Bank Reconciliation ──────────────────────────────────────────────────────

model CuentaBancaria {
  id               String             @id @default(cuid())
  banco            String
  tipoCuenta       TipoCuentaBancaria
  cbu              String?            @unique
  alias            String?
  moneda           String             @default("ARS")
  activa           Boolean            @default(true)
  cuentaContableId String?
  cuentaContable   CuentaContable?    @relation(fields: [cuentaContableId], references: [id])
  extractos        ExtractoBancario[]
  conciliaciones   Conciliacion[]
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
}

model ExtractoBancario {
  id               String          @id @default(cuid())
  cuentaBancariaId String
  cuentaBancaria   CuentaBancaria  @relation(fields: [cuentaBancariaId], references: [id])
  fecha            DateTime
  descripcion      String
  referencia       String?
  monto            Decimal         @db.Decimal(12, 2)
  tipo             TipoMovimientoBancario
  saldo            Decimal?        @db.Decimal(12, 2)
  estado           EstadoExtracto  @default(PENDIENTE)
  conciliacionId   String?
  conciliacion     Conciliacion?   @relation(fields: [conciliacionId], references: [id])
  hash             String          @unique
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  @@index([cuentaBancariaId, fecha])
  @@index([estado])
}

model Conciliacion {
  id                 String              @id @default(cuid())
  cuentaBancariaId   String
  cuentaBancaria     CuentaBancaria      @relation(fields: [cuentaBancariaId], references: [id])
  fechaDesde         DateTime
  fechaHasta         DateTime
  estado             EstadoConciliacion   @default(EN_PROCESO)
  totalMovimientos   Int                 @default(0)
  totalConciliados   Int                 @default(0)
  totalNoConciliados Int                 @default(0)
  matchAutomaticos   Int                 @default(0)
  matchManuales      Int                 @default(0)
  userId             String
  user               User                @relation(fields: [userId], references: [id])
  extractos          ExtractoBancario[]
  matches            ConciliacionMatch[]
  createdAt          DateTime            @default(now())
  completedAt        DateTime?
}

model ConciliacionMatch {
  id             String       @id @default(cuid())
  conciliacionId String
  conciliacion   Conciliacion @relation(fields: [conciliacionId], references: [id])
  extractoId     String
  tipoMatch      TipoMatch
  confianza      Decimal      @db.Decimal(5, 2) // 0-100%
  pagoId         String?
  gastoId        String?
  asientoId      String?
  facturaId      String?
  observaciones  String?
  createdAt      DateTime     @default(now())
}

// ─── Anomaly Detection & Financial Intelligence ───────────────────────────────

model Anomalia {
  id               String    @id @default(cuid())
  tipo             TipoAnomalia
  severidad        SeveridadAnomalia
  titulo           String
  descripcion      String
  entidadTipo      String?   // Pago, Gasto, Factura, Moto, etc.
  entidadId        String?
  montoInvolucrado Decimal?  @db.Decimal(12, 2)
  datosAnalisis    Json?
  estado           EstadoAnomalia @default(NUEVA)
  resueltaPor      String?
  resolucion       String?
  autoDetectada    Boolean   @default(true)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  @@index([tipo, estado])
  @@index([severidad])
  @@index([createdAt])
}

model AnalisisFinanciero {
  id               String   @id @default(cuid())
  tipo             TipoAnalisisFinanciero
  fechaAnalisis    DateTime
  periodo          String   // "2026-02" or "2026-W07" or "2026-02-18"
  metricas         Json
  tendencias       Json?
  alertasGeneradas Int      @default(0)
  createdAt        DateTime @default(now())

  @@unique([tipo, periodo])
}

// ─── Event Monitoring & System Health ─────────────────────────────────────────

model EventMetric {
  id               String   @id @default(cuid())
  periodo          String   // "2026-02-18" or "2026-02-18T14" (hourly)
  granularidad     GranularidadMetrica
  operationId      String
  totalEventos     Int      @default(0)
  exitosos         Int      @default(0)
  fallidos         Int      @default(0)
  tiempoPromedioMs Int?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@unique([periodo, granularidad, operationId])
  @@index([granularidad, periodo])
}

model SystemHealth {
  id               String   @id @default(cuid())
  timestamp        DateTime @default(now())
  eventBusStatus   StatusEventBus
  dbLatencyMs      Int
  handlersActivos  Int
  eventsPendientes Int
  eventsUltima1h   Int
  erroresUltima1h  Int
  memoryUsageMb    Float?
  metricas         Json?

  @@index([timestamp])
}

// ─── Enums: Banking & Reconciliation ─────────────────────────────────────────

enum TipoCuentaBancaria {
  CC_PESOS
  CA_PESOS
  CC_USD
  CA_USD
}

enum TipoMovimientoBancario {
  CREDITO
  DEBITO
}

enum EstadoExtracto {
  PENDIENTE
  CONCILIADO
  NO_CONCILIADO
}

enum EstadoConciliacion {
  EN_PROCESO
  COMPLETADA
  REVISION
}

enum TipoMatch {
  AUTO_EXACTO
  AUTO_APROXIMADO
  MANUAL
}

// ─── Enums: Anomaly Detection ────────────────────────────────────────────────

enum TipoAnomalia {
  GASTO_INUSUAL
  PAGO_DUPLICADO
  FACTURA_SIN_PAGO
  MARGEN_BAJO
  STOCK_CRITICO
  PATRON_SOSPECHOSO
  DESVIO_PRESUPUESTO
  CONCILIACION_PENDIENTE
  VENCIMIENTO_PROXIMO
  FLUJO_CAJA_NEGATIVO
}

enum SeveridadAnomalia {
  BAJA
  MEDIA
  ALTA
  CRITICA
}

enum EstadoAnomalia {
  NUEVA
  EN_REVISION
  RESUELTA
  DESCARTADA
}

// ─── Enums: Event Monitoring ─────────────────────────────────────────────────

enum GranularidadMetrica {
  HORA
  DIA
  SEMANA
  MES
}

enum StatusEventBus {
  HEALTHY
  DEGRADED
  DOWN
}

enum TipoFactura {
  A
  B
  C
}

enum TipoAlerta {
  CONTRATO_CREADO
  CONTRATO_ACTIVADO
  CONTRATO_CANCELADO
  CONTRATO_POR_VENCER
  PAGO
  PAGO_VENCIDO
  URGENTE
  BAJA_MOTO
  MANTENIMIENTO
  MANTENIMIENTO_PROXIMO
  MANTENIMIENTO_NO_ASISTIO
  MANTENIMIENTO_URGENTE
  MANTENIMIENTO_PENDIENTE
  IMPORTACION
  CONCILIACION
  STOCK_BAJO
  MOROSIDAD
  LICENCIA_VENCIDA
  GENERAL
  INFO
}

enum TipoAnalisisFinanciero {
  DIARIO
  SEMANAL
  MENSUAL
}

// ==========================================
// PRICING ENGINE V2 — RENT-TO-OWN
// ==========================================

model CostoOperativoConfig {
  id                         String    @id @unique @default("default")
  seguroRC                   Decimal   @default(0) @db.Decimal(12,2)
  seguroRoboIncendio         Decimal   @default(0) @db.Decimal(12,2)
  seguroTotal                Decimal   @default(0) @db.Decimal(12,2)
  patenteAnual               Decimal   @default(0) @db.Decimal(12,2)
  vtvAnual                   Decimal   @default(0) @db.Decimal(12,2)
  otrosImpuestosAnuales      Decimal   @default(0) @db.Decimal(12,2)
  costoIoTMensual            Decimal   @default(0) @db.Decimal(12,2)
  mantenimientoManoObra      Decimal   @default(0) @db.Decimal(12,2)
  mantenimientoRepuestos     Decimal   @default(0) @db.Decimal(12,2)
  mantenimientoTotal         Decimal   @default(0) @db.Decimal(12,2)
  reservaContingenciaPct     Decimal   @default(5) @db.Decimal(5,2)
  costoMotoParadaDiario      Decimal   @default(0) @db.Decimal(12,2)
  diasParadaEstimadoMes      Decimal   @default(2) @db.Decimal(5,2)
  comisionCobranzaPct        Decimal   @default(4) @db.Decimal(5,2)
  costoAdminPorMoto          Decimal   @default(0) @db.Decimal(12,2)
  morosidadEstimadaPct       Decimal   @default(3) @db.Decimal(5,2)
  costoAlmacenamientoPorMoto Decimal   @default(0) @db.Decimal(12,2)
  tasaInflacionMensualEst    Decimal   @default(3) @db.Decimal(5,2)
  costoCapitalAnualPct       Decimal   @default(0) @db.Decimal(5,2)
  tipoCambioUSD              Decimal   @default(0) @db.Decimal(12,2)
  tipoCambioFuente           String    @default("MANUAL")
  tipoCambioUpdatedAt        DateTime?
  notas                      String?
  createdAt                  DateTime  @default(now())
  updatedAt                  DateTime  @updatedAt
}

model PlanAlquiler {
  id                    String                 @id @default(cuid())
  nombre                String
  codigo                String                 @unique
  descripcion           String?
  duracionMeses         Int
  esRentToOwn           Boolean                @default(false)
  descuentoPct          Decimal                @default(0) @db.Decimal(5,2)
  depositoMeses         Decimal                @default(1) @db.Decimal(5,2)
  depositoConDescuento  Boolean                @default(false)
  permiteSemanal        Boolean                @default(true)
  permiteQuincenal      Boolean                @default(true)
  permiteMensual        Boolean                @default(true)
  recargoSemanalPct     Decimal                @default(10) @db.Decimal(5,2)
  recargoQuincenalPct   Decimal                @default(5) @db.Decimal(5,2)
  recargoEfectivoPct    Decimal                @default(5) @db.Decimal(5,2)
  recargoMercadoPagoPct Decimal                @default(0) @db.Decimal(5,2)
  activo                Boolean                @default(true)
  orden                 Int                    @default(0)
  destacado             Boolean                @default(false)
  contratos             Contrato[]
  preciosPorModelo      PrecioModeloAlquiler[]
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
}

model PrecioModeloAlquiler {
  id                    String       @id @default(cuid())
  modeloMoto            String
  marcaMoto             String?
  planId                String
  plan                  PlanAlquiler @relation(fields: [planId], references: [id], onDelete: Cascade)
  costoLandedUSD        Decimal      @default(0) @db.Decimal(12,2)
  costoLandedARS        Decimal      @default(0) @db.Decimal(12,2)
  amortizacionMensual   Decimal      @default(0) @db.Decimal(12,2)
  costoOperativoMensual Decimal      @default(0) @db.Decimal(12,2)
  costoTotalMensual     Decimal      @default(0) @db.Decimal(12,2)
  precioBaseMensual     Decimal      @default(0) @db.Decimal(12,2)
  precioConDescuento    Decimal      @default(0) @db.Decimal(12,2)
  margenMensual         Decimal      @default(0) @db.Decimal(12,2)
  margenPct             Decimal      @default(0) @db.Decimal(5,2)
  margenObjetivoPct     Decimal      @default(25) @db.Decimal(5,2)
  precioManual          Decimal?     @db.Decimal(12,2)
  motivoOverride        String?
  activo                Boolean      @default(true)
  createdAt             DateTime     @default(now())
  updatedAt             DateTime     @updatedAt

  @@unique([modeloMoto, planId])
  @@index([planId])
  @@index([modeloMoto])
}

model HistorialPrecioAlquiler {
  id             String   @id @default(cuid())
  precioModeloId String?
  modeloMoto     String
  planCodigo     String
  precioAnterior Decimal  @db.Decimal(12,2)
  precioNuevo    Decimal  @db.Decimal(12,2)
  costoLandedARS Decimal  @db.Decimal(12,2)
  tipoCambio     Decimal  @db.Decimal(12,2)
  margenPct      Decimal  @db.Decimal(5,2)
  motivo         String?
  creadoPor      String?
  createdAt      DateTime @default(now())

  @@index([modeloMoto, createdAt])
  @@index([planCodigo])
}

model SimulacionAlquiler {
  id                 String   @id @default(cuid())
  modeloMoto         String
  planCodigo         String
  frecuenciaPago     String
  formaPago          String
  precioBaseMensual  Decimal  @db.Decimal(12,2)
  descuentoPlan      Decimal  @db.Decimal(12,2)
  recargoFrecuencia  Decimal  @db.Decimal(12,2)
  recargoFormaPago   Decimal  @db.Decimal(12,2)
  precioFinalMensual Decimal  @db.Decimal(12,2)
  precioFinalSemanal Decimal? @db.Decimal(12,2)
  deposito           Decimal  @db.Decimal(12,2)
  costoTotal24Meses  Decimal? @db.Decimal(12,2)
  desgloseCostos     Json?
  creadoPor          String?
  createdAt          DateTime @default(now())

  @@index([createdAt])
}
