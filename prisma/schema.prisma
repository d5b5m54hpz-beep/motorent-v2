generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ─── Auth ────────────────────────────────────────────────────────────────────

model User {
  id              String    @id @default(cuid())
  email           String    @unique
  name            String
  image           String?
  provider        String    // "credentials" | "google" | "apple" | "facebook"
  password        String?
  phone           String?
  phoneVerifiedAt DateTime?
  role            Role      @default(CLIENTE)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  cliente         Cliente?
}

enum Role {
  ADMIN
  OPERADOR
  CLIENTE
}

// ─── Negocio ─────────────────────────────────────────────────────────────────

model Cliente {
  id                  String     @id @default(cuid())
  userId              String     @unique
  nombre              String?
  email               String     @unique
  telefono            String?
  dni                 String?
  dniVerificado       Boolean    @default(false)
  licencia            String?
  licenciaVencimiento DateTime?
  licenciaVerificada  Boolean    @default(false)
  direccion           String?
  ciudad              String?
  provincia           String?
  codigoPostal        String?
  fechaNacimiento     DateTime?
  notas               String?
  estado              String     @default("pendiente") // pendiente | aprobado | rechazado
  preRegistro         Json?
  aprobadoPor         String?
  aprobadoAt          DateTime?
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt
  user                User       @relation(fields: [userId], references: [id])
  contratos           Contrato[]
}

model Moto {
  id            String     @id @default(cuid())
  marca         String
  modelo        String
  patente       String     @unique
  anio          Int
  color         String?
  kilometraje   Int        @default(0)
  precioMensual Float      @default(0)
  cilindrada    Int?
  tipo          String?    // naked | touring | sport | scooter | custom
  descripcion   String?
  imagen        String?
  estado        String     @default("disponible") // disponible | alquilada | mantenimiento | baja
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  contratos     Contrato[]
  mantenimientos Mantenimiento[]
}

model Contrato {
  id                String    @id @default(cuid())
  clienteId         String
  motoId            String
  fechaInicio       DateTime
  fechaFin          DateTime
  frecuenciaPago    String    @default("mensual") // semanal | quincenal | mensual
  montoPeriodo      Float     // Monto por período según frecuencia
  montoTotal        Float     // Monto total del contrato
  deposito          Float     @default(0)
  descuentoAplicado Float     @default(0)
  notas             String?
  renovacionAuto    Boolean   @default(false)
  estado            String    @default("pendiente") // pendiente | activo | finalizado | cancelado
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  cliente           Cliente   @relation(fields: [clienteId], references: [id])
  moto              Moto      @relation(fields: [motoId], references: [id])
  pagos             Pago[]
  alertas           Alerta[]
}

model Pago {
  id            String    @id @default(cuid())
  contratoId    String
  monto         Float
  metodo        String    @default("pendiente") // transferencia | tarjeta | mercadopago | efectivo | pendiente
  estado        String    @default("pendiente") // pendiente | aprobado | rechazado | reembolsado | cancelado
  referencia    String?
  mpPaymentId   String?   // ID de transacción de MercadoPago
  comprobante   String?   // URL o texto del comprobante
  notas         String?   // Notas adicionales del pago
  pagadoAt      DateTime?
  vencimientoAt DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  contrato      Contrato  @relation(fields: [contratoId], references: [id])
  factura       Factura?
  alertas       Alerta[]
}

model Factura {
  id             String    @id @default(cuid())
  numero         String    // Autoincremental 00000001, 00000002, etc.
  tipo           String    // A, B, C
  puntoVenta     Int       @default(1)
  montoNeto      Float     // Subtotal sin IVA (si tipo A)
  montoIva       Float     // IVA 21% (si tipo A)
  montoTotal     Float     // Total final
  cae            String?   // Código de Autorización Electrónico de AFIP
  caeVencimiento String?   // Fecha de vencimiento del CAE
  razonSocial    String?   // Razón social del cliente (opcional)
  cuit           String?   // CUIT del cliente (opcional)
  emitida        Boolean   @default(false) // false = pendiente AFIP, true = emitida con CAE
  emailEnviado   Boolean   @default(false) // true si se envió por email
  emailEnviadoAt DateTime? // Fecha/hora del último envío por email
  pagoId         String    @unique
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  pago           Pago      @relation(fields: [pagoId], references: [id])
}

model Alerta {
  id              String    @id @default(cuid())
  tipo            String
  mensaje         String
  metadata        Json?
  contratoId      String?
  pagoId          String?
  leida           Boolean   @default(false)
  dniVerificacion Json?
  createdAt       DateTime  @default(now())
  contrato        Contrato? @relation(fields: [contratoId], references: [id])
  pago            Pago?     @relation(fields: [pagoId], references: [id])
}

// ─── Mantenimiento ──────────────────────────────────────────────────────────

model Mantenimiento {
  id                String              @id @default(cuid())
  visibleId         String              @unique @default(cuid())
  motoId            String
  moto              Moto                @relation(fields: [motoId], references: [id])
  tipo              TipoMantenimiento
  estado            EstadoMantenimiento @default(PENDIENTE)
  descripcion       String
  diagnostico       String?
  solucion          String?
  costoRepuestos    Float               @default(0)
  costoManoObra     Float               @default(0)
  costoTotal        Float               @default(0)
  proveedorId       String?
  proveedor         Proveedor?          @relation(fields: [proveedorId], references: [id])
  kmAlMomento       Int?
  fechaProgramada   DateTime?
  fechaInicio       DateTime?
  fechaFin          DateTime?
  proximoServiceKm    Int?
  proximoServiceFecha DateTime?
  notas             String?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  repuestos         RepuestoUsado[]
}

model Proveedor {
  id             String          @id @default(cuid())
  visibleId      String          @unique @default(cuid())
  nombre         String
  contacto       String?
  telefono       String?
  email          String?
  direccion      String?
  rubro          String?
  notas          String?
  activo         Boolean         @default(true)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  mantenimientos Mantenimiento[]
  repuestos      Repuesto[]
}

model Repuesto {
  id           String         @id @default(cuid())
  visibleId    String         @unique @default(cuid())
  nombre       String
  codigo       String?
  categoria    String?
  precioCompra Float          @default(0)
  precioVenta  Float          @default(0)
  stock        Int            @default(0)
  stockMinimo  Int            @default(2)
  proveedorId  String?
  proveedor    Proveedor?     @relation(fields: [proveedorId], references: [id])
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  usos         RepuestoUsado[]
}

model RepuestoUsado {
  id              String        @id @default(cuid())
  mantenimientoId String
  mantenimiento   Mantenimiento @relation(fields: [mantenimientoId], references: [id], onDelete: Cascade)
  repuestoId      String
  repuesto        Repuesto      @relation(fields: [repuestoId], references: [id])
  cantidad        Int           @default(1)
  precioUnitario  Float
  subtotal        Float
  createdAt       DateTime      @default(now())
}

enum TipoMantenimiento {
  SERVICE_PREVENTIVO
  REPARACION
  CAMBIO_ACEITE
  CAMBIO_NEUMATICOS
  FRENOS
  ELECTRICA
  CHAPA_PINTURA
  OTRO
}

enum EstadoMantenimiento {
  PENDIENTE
  PROGRAMADO
  EN_PROCESO
  ESPERANDO_REPUESTO
  COMPLETADO
  CANCELADO
}

// ─── Pricing ────────────────────────────────────────────────────────────────

model PricingConfig {
  id                String   @id @unique @default("default")
  precioBaseMensual Float
  descuentoSemanal  Float
  descuentoMeses3   Float
  descuentoMeses6   Float
  descuentoMeses9   Float
  descuentoMeses12  Float
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}
